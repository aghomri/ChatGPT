<?php
ini_set('display_errors', 0);
error_reporting(E_ALL);
session_start();

$UI_BUILD = '2025-10-26 v12: SRAPS links+Global settings fixes';
header('X-UI-Build: '.$UI_BUILD);

ini_set('default_charset', 'UTF-8');
if (function_exists('mb_internal_encoding')) mb_internal_encoding('UTF-8');
if (function_exists('mb_http_output')) mb_http_output('UTF-8');
header('Content-Type: text/html; charset=UTF-8');

function provision_log($line){
    @file_put_contents(__DIR__ . '/../provision_debug.log', date('c').' '.$line.PHP_EOL, FILE_APPEND);
}

function clean_utf8($s) {
    if ($s === null) return '';
    if (!is_string($s)) $s = (string)$s;
    if (function_exists('mb_detect_encoding') && function_exists('mb_convert_encoding')) {
        $enc = @mb_detect_encoding($s, ['UTF-8','UTF-16','Windows-1252','ISO-8859-1'], true);
        if ($enc && $enc !== 'UTF-8') {
            $s = @mb_convert_encoding($s, 'UTF-8', $enc);
        }
    }
    return $s;
}
function sanitize_for_ui(string $s): string {
    $s = clean_utf8($s);
    $s = preg_replace('/[\x00-\x08\x0B\x0C\x0E-\x1F]/u', '', $s);
    $s = preg_replace('/\s+/u', ' ', $s);
    return trim($s);
}
function e($s){
    return htmlspecialchars(sanitize_for_ui((string)$s), ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
}
function normalize_mac(string $s): string { return strtoupper(preg_replace('/[^A-Fa-f0-9]/','',$s)); }
function is_valid_mac(string $s): bool { $m = normalize_mac($s); return ($m !== '') && preg_match('/^[A-F0-9]{12}$/', $m) === 1; }
function random_password($len = 16) {
    if ($len < 1) $len = 16;
    $chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%&*()-_=+[]{}?,.:;~';
    $out = ''; $max = strlen($chars)-1;
    for ($i=0;$i<$len;$i++) $out .= $chars[random_int(0,$max)];
    return $out;
}
function fkey_cap_for_model(string $model): int {
    $m = strtoupper(trim($model));
    if ($m === 'D895') return 236;
    if (in_array($m, ['D815','D892','D865'], true)) return 220;
    if (in_array($m, ['D862','D812'], true)) return 212;
    return 212;
}
function dscp_to_tos(?string $dscp): ?int {
    if ($dscp === null) return null;
    $dscp = trim((string)$dscp);
    if ($dscp === '' || !preg_match('/^\d+$/', $dscp)) return null;
    $v = (int)$dscp;
    if ($v < 0) $v = 0;
    if ($v > 63) $v = 63;
    return $v * 4;
}

if (!file_exists(__DIR__ . '/db.php')) { provision_log('db.php missing'); die("Missing db.php - cannot continue"); }
require_once __DIR__ . '/db.php';
if (empty($_SESSION['user_id'])) { header('Location: login.php'); exit; }
$uid = (int)$_SESSION['user_id'];

try { $pdo = db(); } catch (Throwable $e) { provision_log('db() error: '.$e->getMessage()); die("DB error"); }

function ensure_system_wiz_table(PDO $pdo) {
    try { $pdo->exec("CREATE TABLE IF NOT EXISTS system_wiz (system_id INTEGER, user_id INTEGER, data TEXT NOT NULL, updated_at TEXT, PRIMARY KEY (system_id, user_id))"); }
    catch (Throwable $e) { provision_log('ensure_system_wiz_table error: '.$e->getMessage()); }
}
function load_wiz_from_db(PDO $pdo, int $sysId, int $uid): ?array {
    try {
        $st = $pdo->prepare('SELECT data FROM system_wiz WHERE system_id = ? AND user_id = ? LIMIT 1');
        $st->execute([$sysId, $uid]);
        $row = $st->fetchColumn();
        if ($row) { $arr = json_decode($row, true); if (is_array($arr)) return $arr; }
    } catch (Throwable $e) { provision_log('load_wiz_from_db error: '.$e->getMessage()); }
    return null;
}
function save_wiz_to_db(PDO $pdo, int $sysId, int $uid, array $wiz): bool {
    $json = json_encode($wiz, JSON_UNESCAPED_UNICODE);
    if ($json === false) { provision_log('save_wiz_to_db json_encode failed'); return false; }
    $ts = date('c');
    try {
        $st = $pdo->prepare('UPDATE system_wiz SET data = ?, updated_at = ? WHERE system_id = ? AND user_id = ?');
        $st->execute([$json, $ts, $sysId, $uid]);
        if ($st->rowCount() === 0) {
            $st2 = $pdo->prepare('INSERT INTO system_wiz (system_id, user_id, data, updated_at) VALUES (?,?,?,?)');
            $st2->execute([$sysId, $uid, $json, $ts]);
        }
        return true;
    } catch (Throwable $e) { provision_log('save_wiz_to_db error: '.$e->getMessage()); return false; }
}
ensure_system_wiz_table($pdo);

/* Load system */
$sysId = isset($_REQUEST['system_id']) ? (int)$_REQUEST['system_id'] : 0;
$st = $pdo->prepare('SELECT * FROM systems WHERE id=? AND user_id=?');
$st->execute([$sysId, $uid]);
$sys = $st->fetch(PDO::FETCH_ASSOC);
if (!$sys) { http_response_code(404); die('<pre>Invalid or unauthorized system ID.</pre>'); }
$sys['label'] = isset($sys['label']) ? sanitize_for_ui((string)$sys['label']) : 'Provisioning';

/* All sites (Switch Site) */
$sites = [];
try {
    $stSites = $pdo->prepare('SELECT id, label, host FROM systems WHERE user_id = ? ORDER BY label ASC, id ASC');
    $stSites->execute([$uid]);
    while ($r = $stSites->fetch(PDO::FETCH_ASSOC)) {
        $sites[] = [
            'id'    => (int)$r['id'],
            'label' => sanitize_for_ui((string)($r['label'] ?? 'Site '.$r['id'])),
            'host'  => sanitize_for_ui((string)($r['host'] ?? ''))
        ];
    }
} catch (Throwable $e) { provision_log('Switch Site load error: '.$e->getMessage()); }

/* Assets/paths */
$local_logo_path = 'assets/logos/snom_logo_gray_60.svg';
$logo_src = file_exists(__DIR__.'/'.$local_logo_path)
    ? $local_logo_path
    : 'data:image/svg+xml;utf8,' . rawurlencode('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="88"><rect rx="8" width="120" height="88" fill="#eef6ff"/><text x="50%" y="50%" font-size="20" fill="#0b2548" text-anchor="middle" dominant-baseline="central">snom</text></svg>');

$PROVISION_DIR = rtrim(__DIR__, '/').'/provisioning_files';
if (!is_dir($PROVISION_DIR)) { @mkdir($PROVISION_DIR, 0777, true); @chmod($PROVISION_DIR, 0777); }
$PUBLIC_PROVISION_PATH = '/' . trim(str_replace(rtrim($_SERVER['DOCUMENT_ROOT'],'/'), '', $PROVISION_DIR), '/');
if ($PUBLIC_PROVISION_PATH === '') $PUBLIC_PROVISION_PATH = '/provisioning_files';

/* Session wizard state */
if (!isset($_SESSION['wiz'])) $_SESSION['wiz'] = [];
if (!isset($_SESSION['wiz'][$sysId])) $_SESSION['wiz'][$sysId] = [
    'exts'=>[],'assign'=>[],'settings'=>[],'generated'=>[],'global'=>[],'flash'=>null,
    'sraps'=>[
        'baseUrl'=>'https://api.sraps.snom.com/api/v1/',
        'orgId'=>'','accessKey'=>'','secretKey'=>'',
        'statusOK'=>false,'statusAt'=>'',
        'profilesCat'=>['D'=>'','M'=>'','M500'=>'','HOTEL'=>'']
    ]
];
$wiz = &$_SESSION['wiz'][$sysId];
if ($db_wiz = load_wiz_from_db($pdo, $sysId, $uid)) { $_SESSION['wiz'][$sysId] = array_replace_recursive($wiz, $db_wiz); $wiz = &$_SESSION['wiz'][$sysId]; }

/* CSV parsing/upload */
function parse_mac_csv($tmpfile){
    $out=[]; $fh=@fopen($tmpfile,'r'); if(!$fh) return [false,'Cannot open file'];
    $first=fgetcsv($fh); if($first===false){ fclose($fh); return [false,'Empty CSV']; }
    $hdr=array_map('trim',$first); $hasHeader=false; $h0=strtolower($hdr[0]??'');
    if(strpos($h0,'mac')!==false||strpos($h0,'model')!==false) $hasHeader=true;
    if($hasHeader){
        while(($row=fgetcsv($fh))!==false){
            if(!isset($row[0])) continue;
            $mac=strtoupper(preg_replace('/[^A-Fa-f0-9]/','',(string)$row[0])); if($mac==='') continue;
            $model=trim($row[1]??''); $label=trim($row[2]??'');
            $out[]=['mac'=>$mac,'model'=>$model,'label'=>$label];
        }
    } else {
        $row=$hdr;
        if(isset($row[0])){ $mac=strtoupper(preg_replace('/[^A-Fa-f0-9]/','',(string)$row[0])); if($mac!=='') $out[]=['mac'=>$mac,'model'=>trim($row[1]??''),'label'=>trim($row[2]??'')]; }
        while(($row=fgetcsv($fh))!==false){
            if(!isset($row[0])) continue;
            $mac=strtoupper(preg_replace('/[^A-Fa-f0-9]/','',(string)$row[0])); if($mac==='') continue;
            $out[]=['mac'=>$mac,'model'=>trim($row[1]??''),'label'=>trim($row[2]??'')];
        }
    }
    fclose($fh);
    return [true,$out];
}
$csv_msg = '';
if ($_SERVER['REQUEST_METHOD']==='POST' && isset($_FILES['mac_csv']) && is_uploaded_file($_FILES['mac_csv']['tmp_name'])) {
    [$ok,$res]=parse_mac_csv($_FILES['mac_csv']['tmp_name']);
    if(!$ok){ $csv_msg = $res; }
    else {
        $_SESSION['mac_list'] = [];
        foreach ($res as $r) {
            $k = strtoupper(preg_replace('/[^A-Fa-f0-9]/','', (string)($r['mac'] ?? '')));
            if ($k === '') continue;
            $_SESSION['mac_list'][$k] = ['mac'=>$k,'model'=>$r['model'] ?? '','label'=>$r['label'] ?? ''];
        }
        $_SESSION['mac_mode'] = 'csv_only';
        $_SESSION['mac_prompt_shown'] = true;
        $wiz['flash'] = ['msg' => 'CSV upload completed.', 'type' => 'success'];
        save_wiz_to_db($pdo, $sysId, $uid, $wiz);
        header('Location: extensions.php?system_id='.(int)$sysId); exit;
    }
}
if ($_SERVER['REQUEST_METHOD']==='POST' && isset($_POST['clear_mac_list'])) { unset($_SESSION['mac_list']); $_SESSION['mac_mode']='allow_manual'; $csv_msg="MAC list cleared."; save_wiz_to_db($pdo,$sysId,$uid,$wiz); }

/* UCM helpers & load */
function api_post_json($url,$json,$cookie=null){
    $ch=curl_init($url);
    $hdr=['Content-Type: application/json;charset=UTF-8']; if($cookie)$hdr[]='Cookie: '.$cookie;
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $json,
        CURLOPT_HTTPHEADER => $hdr,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_SSL_VERIFYHOST => 0,
        CURLOPT_TIMEOUT => 25,
        CURLOPT_CONNECTTIMEOUT => 8,
    ]);
    $resp=curl_exec($ch); if($resp===false){ $err=curl_error($ch); curl_close($ch); return ['error'=>$err]; }
    $code=curl_getinfo($ch,CURLINFO_RESPONSE_CODE); curl_close($ch);
    return ['http_code'=>$code,'json'=>@json_decode($resp,true),'raw'=>$resp];
}
function do_challenge($base,$user){ return api_post_json($base,json_encode(['request'=>['action'=>'challenge','user'=>$user,'version'=>'1.0']])); }
function do_login($base,$user,$token){ return api_post_json($base,json_encode(['request'=>['action'=>'login','user'=>$user,'token'=>$token]])); }
function do_listAccount($base,$cookie){ return api_post_json($base,json_encode(['request'=>['action'=>'listAccount','cookie'=>$cookie,'item_num'=>'2000','page'=>'1']])); }
function do_getSIPAccount($base,$cookie,$ext){ return api_post_json($base,json_encode(['request'=>['action'=>'getSIPAccount','cookie'=>$cookie,'extension'=>(string)$ext]])); }

$msg=''; $exts = $wiz['exts'] ?? [];
if ((isset($_POST['fetch_ucm']) && $_POST['fetch_ucm']) || empty($exts)) {
    $host=$sys['host']; $port=(int)$sys['port']; $user=$sys['username']; $pass=base64_decode($sys['password_encrypted'] ?? '');
    $base="https://{$host}:{$port}/api";
    $ch=do_challenge($base,$user);
    if(!isset($ch['json']['response']['challenge'])){ $msg="Challenge failed."; $exts=[]; }
    else {
        $token=md5($ch['json']['response']['challenge'] . $pass);
        $lo=do_login($base,$user,$token);
        if(!isset($lo['json']['response']['cookie'])){ $msg="Login failed"; $exts=[]; }
        else {
            $cookie=$lo['json']['response']['cookie'];
            $list=do_listAccount($base,$cookie);
            $result=[];
            if(isset($list['json']['response']['account']) && is_array($list['json']['response']['account'])){
                foreach($list['json']['response']['account'] as $acct){
                    $extension=$acct['extension'] ?? null; if(!$extension) continue;
                    $sip = do_getSIPAccount($base,$cookie,$extension);
                    if(isset($sip['json']['response']['extension'])) {
                        $e=$sip['json']['response']['extension'];
                        $result[]=[
                            'extension'=>$e['extension'] ?? $extension,
                            'fullname'=>sanitize_for_ui($e['fullname'] ?? ''),
                            'authid'=>$e['authid'] ?? ($e['authenticate_id'] ?? $extension),
                            'secret'=>$e['secret'] ?? ''
                        ];
                    }
                }
            }
            $exts = $wiz['exts'] = $result;
            save_wiz_to_db($pdo,$sysId,$uid,$wiz);
            $msg = $msg ?: ("Loaded ".count($exts)." extensions.");
        }
    }
}

/* Fullname map for labels */
$fullname_by_ext = [];
foreach ($exts as $ee) {
    $fullname_by_ext[(string)($ee['extension'] ?? '')] = sanitize_for_ui($ee['fullname'] ?? '');
}

/* Write profile (XML) */
function write_profile($dir, $ucm_host, $extInfo, $mac, $overrides = [], $all_exts = []) {
    $mac = strtoupper(preg_replace('/[^A-Fa-f0-9]/','', (string)$mac));
    if ($mac === '') return [false, 'Invalid MAC'];
    if (empty($dir)) $dir = rtrim(__DIR__,'/').'/provisioning_files';
    if (!is_dir($dir)) { if (!@mkdir($dir, 0777, true)) return [false, "Cannot create provisioning directory: {$dir}"]; @chmod($dir, 0777); }
    if (!is_writable($dir)) return [false, "Provisioning directory not writable: {$dir}"];

    $ext = (string)($extInfo['extension'] ?? '');
    $fullname = sanitize_for_ui((string)($extInfo['fullname'] ?? ''));
    $password = $extInfo['secret'] ?? ($overrides['auth_password'] ?? '');

    $prov_path = (string)($overrides['setting_server'] ?? '');
    $sip_server = (string)$ucm_host;

    $model = $overrides['__model'] ?? '';
    $cap = fkey_cap_for_model((string)$model);

    $blf_rows_in = is_array($overrides['__blf'] ?? []) ? $overrides['__blf'] : [];
    $blf_rows_in = array_slice($blf_rows_in, 0, max(0, (int)$cap));

    $fullname_map = [];
    foreach ($all_exts as $ae) { $fullname_map[(string)$ae['extension']] = sanitize_for_ui($ae['fullname'] ?? ''); }

    $admin_pass = isset($overrides['http_pass']) && $overrides['http_pass'] !== '' ? (string)$overrides['http_pass'] : random_password(16);
    $user_pass  = isset($overrides['user_http_pass']) && $overrides['user_http_pass'] !== '' ? (string)$overrides['user_http_pass'] : random_password(16);

    if (($overrides['force_admin_password'] ?? '') === 'on' && !empty($overrides['forced_admin_password'])) {
        $admin_pass = (string)$overrides['forced_admin_password'];
    }

    $custom_xml_global = (string)($overrides['custom_xml_global'] ?? '');
    $custom_xml_ext    = (string)($overrides['custom_xml'] ?? '');

    $sip_tos = dscp_to_tos($overrides['net_dscp_sip'] ?? null);
    $rtp_tos = dscp_to_tos($overrides['net_dscp_rtp'] ?? null);
    if ($sip_tos === null) $sip_tos = 184;
    if ($rtp_tos === null) $rtp_tos = 184;

    $lan_vlan = (string)($overrides['net_vlan_lan'] ?? ($overrides['net_vlan_voice'] ?? ''));
    $pc_vlan  = (string)($overrides['net_vlan_pc'] ?? '');

    $transport = strtolower((string)($overrides['sec_sip_transport'] ?? 'udp'));
    $user_host_value = $sip_server;
    if (in_array($transport, ['tcp','tls'], true)) {
        $user_host_value = $sip_server . ';transport=' . $transport;
    } elseif ($transport === 'udp') {
        $user_host_value = $sip_server;
    }

    $vm_key = (string)($overrides['vm_key'] ?? '');
    $call_waiting = (string)($overrides['call_waiting'] ?? 'on');
    $transfer_on_hangup = (string)($overrides['transfer_on_hangup'] ?? 'off');
    $transfer_on_hangup_non_pots = (string)($overrides['transfer_on_hangup_non_pots'] ?? 'off');
    $quick_transfer = (string)($overrides['quick_transfer'] ?? 'attended');
    $transfer_dialing_on = (string)($overrides['transfer_dialing_on'] ?? 'attended');
    $mute_is_dnd_in_idle = (string)($overrides['mute_is_dnd_in_idle'] ?? 'on');

    $tbook_url = (string)($overrides['contacts_tbook_url'] ?? '');

    $xml  = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";

    $xml .= "<settings>\n";
    $xml .= "  <phone-settings e=\"2\">\n";

    $xml .= "    <user_active idx=\"1\" perm=\"RW\">on</user_active>\n";
    $xml .= "    <user_idle_text idx=\"1\" perm=\"RW\">".htmlspecialchars(clean_utf8($fullname), ENT_QUOTES, 'UTF-8')."</user_idle_text>\n";
    $xml .= "    <user_idle_number idx=\"1\" perm=\"RW\">".htmlspecialchars($ext, ENT_QUOTES, 'UTF-8')."</user_idle_number>\n";
    $xml .= "    <user_name idx=\"1\" perm=\"RW\">".htmlspecialchars($ext, ENT_QUOTES, 'UTF-8')."</user_name>\n";
    $xml .= "    <user_pname idx=\"1\" perm=\"RW\">".htmlspecialchars($ext, ENT_QUOTES, 'UTF-8')."</user_pname>\n";
    if ($password !== '') $xml .= "    <user_pass idx=\"1\" perm=\"RW\">".htmlspecialchars($password, ENT_QUOTES, 'UTF-8')."</user_pass>\n";
    $xml .= "    <user_realname idx=\"1\" perm=\"RW\">".htmlspecialchars(clean_utf8($fullname), ENT_QUOTES, 'UTF-8')."</user_realname>\n";

    if ($user_host_value !== '') {
        $xml .= "    <user_host idx=\"1\" perm=\"RW\">".htmlspecialchars($user_host_value, ENT_QUOTES, 'UTF-8')."</user_host>\n";
        $xml .= "    <user_outbound idx=\"1\" perm=\"RW\">".htmlspecialchars($user_host_value, ENT_QUOTES, 'UTF-8')."</user_outbound>\n";
    }

    if ($prov_path !== '') {
        $xml .= "    <setting_server perm=\"RW\">".htmlspecialchars($prov_path, ENT_QUOTES, 'UTF-8')."</setting_server>\n";
    }

    if (!empty($overrides['codec_priority_list'])) {
        $xml .= "    <codec_priority_list idx=\"1\" perm=\"RW\">".htmlspecialchars($overrides['codec_priority_list'], ENT_QUOTES, 'UTF-8')."</codec_priority_list>\n";
    }
    if (!empty($overrides['rtp_port_start'])) {
        $xml .= "    <rtp_port_start perm=\"RW\">".htmlspecialchars($overrides['rtp_port_start'], ENT_QUOTES, 'UTF-8')."</rtp_port_start>\n";
    }
    if (!empty($overrides['rtp_port_end'])) {
        $xml .= "    <rtp_port_end perm=\"RW\">".htmlspecialchars($overrides['rtp_port_end'], ENT_QUOTES, 'UTF-8')."</rtp_port_end>\n";
    }

    $xml .= "    <codec_tos perm=\"RW\">".$rtp_tos."</codec_tos>\n";
    $xml .= "    <signaling_tos perm=\"RW\">".$sip_tos."</signaling_tos>\n";

    if ($lan_vlan !== '') {
        $xml .= "    <vlan_id perm=\"RW\">".htmlspecialchars(preg_replace('/\D/','',(string)$lan_vlan), ENT_QUOTES, 'UTF-8')."</vlan_id>\n";
        $xml .= "    <vlan_port_tagging perm=\"RW\">on</vlan_port_tagging>\n";
    }
    if ($pc_vlan !== '') {
        $xml .= "    <pc_port_vlan_id perm=\"RW\">".htmlspecialchars(preg_replace('/\D/','',(string)$pc_vlan), ENT_QUOTES, 'UTF-8')."</pc_port_vlan_id>\n";
        $xml .= "    <pc_port_tagging perm=\"RW\">on</pc_port_tagging>\n";
    }

    if (!empty($overrides['loc_lcd_language'])) {
        $xml .= "    <language perm=\"RW\">".htmlspecialchars($overrides['loc_lcd_language'], ENT_QUOTES, 'UTF-8')."</language>\n";
    } elseif (!empty($overrides['loc_language'])) {
        $xml .= "    <language perm=\"RW\">".htmlspecialchars($overrides['loc_language'], ENT_QUOTES, 'UTF-8')."</language>\n";
    }
    if (!empty($overrides['loc_web_language'])) {
        $xml .= "    <web_language perm=\"RW\">".htmlspecialchars($overrides['loc_web_language'], ENT_QUOTES, 'UTF-8')."</web_language>\n";
    }
    if (!empty($overrides['loc_timezone'])) {
        $xml .= "    <timezone perm=\"RW\">".htmlspecialchars($overrides['loc_timezone'], ENT_QUOTES, 'UTF-8')."</timezone>\n";
    }
    if (!empty($overrides['loc_locale'])) {
        $xml .= "    <locale perm=\"RW\">".htmlspecialchars($overrides['loc_locale'], ENT_QUOTES, 'UTF-8')."</locale>\n";
    }
    if (!empty($overrides['ntp_server'])) {
        $xml .= "    <ntp_server perm=\"RW\">".htmlspecialchars($overrides['ntp_server'], ENT_QUOTES, 'UTF-8')."</ntp_server>\n";
    }
    if (isset($overrides['ntp_refresh_timer']) && $overrides['ntp_refresh_timer'] !== '') {
        $ntpInt = (int)$overrides['ntp_refresh_timer']; if ($ntpInt < 0) $ntpInt = 0;
        $xml .= "    <ntp_refresh_timer perm=\"RW\">".$ntpInt."</ntp_refresh_timer>\n";
    }

    if (isset($overrides['contacts_ldap_enable'])) {
        $xml .= "    <ldap_enable perm=\"RW\">".($overrides['contacts_ldap_enable']==='on' ? 'on' : 'off')."</ldap_enable>\n";
    }
    $xml .= "    <dkey_directory perm=\"RW\">".htmlspecialchars($tbook_url, ENT_QUOTES, 'UTF-8')."</dkey_directory>\n";

    if (!empty($model)) {
        $modelKey = 'maint_fw_' . strtoupper($model);
        if (!empty($overrides[$modelKey])) {
            $xml .= "    <firmware perm=\"RW\">".htmlspecialchars($overrides[$modelKey], ENT_QUOTES, 'UTF-8')."</firmware>\n";
        }
    }
    if (!empty($overrides['syslog_server'])) {
        $xml .= "    <syslog_server perm=\"RW\">".htmlspecialchars($overrides['syslog_server'], ENT_QUOTES, 'UTF-8')."</syslog_server>\n";
    }

    if (isset($overrides['prov_polling_period'])) {
        $period = (int)$overrides['prov_polling_period'];
        if ($period < 0) $period = 0;
        if ($period > 3600) $period = 3600;
        if ($period > 0) {
            $xml .= "    <prov_polling_enabled perm=\"RW\">on</prov_polling_enabled>\n";
            $xml .= "    <prov_polling_mode perm=\"RW\">rel</prov_polling_mode>\n";
            $xml .= "    <prov_polling_period perm=\"RW\">".$period."</prov_polling_period>\n";
        } else {
            $xml .= "    <prov_polling_enabled perm=\"RW\">off</prov_polling_enabled>\n";
        }
    }

    if ($transport !== '' && in_array($transport, ['udp','tcp','tls'], true)) {
        $xml .= "    <user_media_transport_offer idx=\"1\" perm=\"RW\">".$transport."</user_media_transport_offer>\n";
    }
    if ($vm_key !== '') {
        $xml .= "    <user_mailbox idx=\"1\" perm=\"RW\">".htmlspecialchars($vm_key, ENT_QUOTES, 'UTF-8')."</user_mailbox>\n";
    } else {
        $xml .= "    <user_mailbox idx=\"1\" perm=\"RW\">".htmlspecialchars($ext, ENT_QUOTES, 'UTF-8')."</user_mailbox>\n";
    }
    $xml .= "    <call_waiting perm=\"RW\">".htmlspecialchars($call_waiting, ENT_QUOTES, 'UTF-8')."</call_waiting>\n";
    $xml .= "    <transfer_on_hangup perm=\"RW\">".htmlspecialchars($transfer_on_hangup, ENT_QUOTES, 'UTF-8')."</transfer_on_hangup>\n";
    $xml .= "    <transfer_on_hangup_non_pots perm=\"RW\">".htmlspecialchars($transfer_on_hangup_non_pots, ENT_QUOTES, 'UTF-8')."</transfer_on_hangup_non_pots>\n";
    $xml .= "    <quick_transfer perm=\"RW\">".htmlspecialchars($quick_transfer, ENT_QUOTES, 'UTF-8')."</quick_transfer>\n";
    $xml .= "    <transfer_dialing_on perm=\"RW\">".htmlspecialchars($transfer_dialing_on, ENT_QUOTES, 'UTF-8')."</transfer_dialing_on>\n";
    $xml .= "    <mute_is_dnd_in_idle perm=\"RW\">".htmlspecialchars($mute_is_dnd_in_idle, ENT_QUOTES, 'UTF-8')."</mute_is_dnd_in_idle>\n";

    $xml .= "    <webserver_user_name perm=\"RW\">user</webserver_user_name>\n";
    $xml .= "    <webserver_user_password perm=\"RW\">".htmlspecialchars($user_pass, ENT_QUOTES, 'UTF-8')."</webserver_user_password>\n";
    $xml .= "    <http_user perm=\"RW\">admin</http_user>\n";
    $xml .= "    <webserver_admin_name perm=\"RW\">admin</webserver_admin_name>\n";
    $xml .= "    <http_pass perm=\"RW\">".htmlspecialchars($admin_pass, ENT_QUOTES, 'UTF-8')."</http_pass>\n";
    $xml .= "    <admin_mode_password perm=\"RW\">".htmlspecialchars($admin_pass, ENT_QUOTES, 'UTF-8')."</admin_mode_password>\n";
    $xml .= "    <webserver_admin_password perm=\"RW\">".htmlspecialchars($admin_pass, ENT_QUOTES, 'UTF-8')."</webserver_admin_password>\n";

    if (trim($custom_xml_global) !== '') {
        foreach (explode("\n", $custom_xml_global) as $L) { $xml .= '    ' . rtrim($L) . "\n"; }
    }
    if (trim($custom_xml_ext) !== '') {
        foreach (explode("\n", $custom_xml_ext) as $L) { $xml .= '    ' . rtrim($L) . "\n"; }
    }

    $xml .= "  </phone-settings>\n";

    $xml .= "  <functionKeys e=\"2\">\n";
    $i = 0;
    foreach ($blf_rows_in as $row) {
        $value = (string)($row['value'] ?? '');
        if ($value === '') continue;

        if (isset($fullname_map[$value]) && $fullname_map[$value] !== '') {
            $name = $fullname_map[$value];
        } elseif (!empty($row['label'])) {
            $name = $row['label'];
        } else {
            $name = $value;
        }

        $nameEsc = htmlspecialchars($name, ENT_QUOTES, 'UTF-8');
        $valEsc  = htmlspecialchars($value, ENT_QUOTES, 'UTF-8');

        $xml .= '    <fkey idx="'.(int)$i.'" context="active" short_label_mode="icon_text" short_label="'.
                $nameEsc.'" short_default_text="!!$(::)!!$(generate_via_conditional_label_short)" label_mode="icon_text" icon_type="" reg_label_mode="icon_text" ringer="Silent" park_retrieve="" label="'.
                $nameEsc.'" lp="on" default_text="!!$(::)!!$(generate_via_conditional_label_full)" perm="RW">blf '.$valEsc."</fkey>\n";

        $i++;
        if ($i >= $cap) break;
    }
    $xml .= "  </functionKeys>\n";

    $xml .= "</settings>\n";

    $file = rtrim($dir, '/')."/{$mac}.xml";
    $res = @file_put_contents($file, $xml);
    if ($res === false) {
        return [false, "Write failed for {$file}"];
    }
    @chmod($file, 0666);
    return [true, $mac];
}

/* Merge assign helper */
function merge_assign_into_session(array $postedAssign, array &$wiz, string &$errMsg): bool {
    $errors=[]; $existing=[];
    foreach ($wiz['assign'] as $aext=>$adata){ $am=normalize_mac((string)($adata['mac'] ?? '')); if($am!=='') $existing[$am]=$aext; }
    foreach ($postedAssign as $ext=>$row) {
        $raw = trim((string)($row['mac'] ?? ''));
        $macnorm = normalize_mac($raw);
        $model = trim((string)($row['model'] ?? ''));
        if ($macnorm !== '' && strlen($macnorm) !== 12) $errors[] = "Invalid MAC for {$ext}. Expect 12 hex characters.";
        else if ($macnorm !== '' && isset($existing[$macnorm]) && $existing[$macnorm] !== $ext) $errors[] = "MAC {$macnorm} already assigned to {$existing[$macnorm]}";
    }
    if (!empty($errors)) { $errMsg = implode('; ', $errors); return false; }
    foreach ($postedAssign as $ext=>$row) {
        $raw = trim((string)($row['mac'] ?? ''));
        $macnorm = normalize_mac($raw);
        $model = trim((string)($row['model'] ?? ''));
        if (!isset($wiz['assign'][$ext])) $wiz['assign'][$ext]=['mac'=>'','model'=>''];
        $wiz['assign'][$ext]['mac'] = $macnorm ?: '';
        $wiz['assign'][$ext]['model'] = $model ?: '';
    }
    return true;
}

/* ---------- SRAPS helpers: Hawk signing + request + robust links ---------- */
function canonical_content_type(string $contentType): string {
    if ($contentType === '') return '';
    $base = explode(';', $contentType, 2)[0];
    return strtolower(trim($base));
}
function hawk_payload_hash(string $payload, string $contentType, string $algorithm = 'sha256'): string {
    $normalized = "hawk.1.payload\n" . canonical_content_type($contentType) . "\n" . $payload . "\n";
    $digest = hash($algorithm, $normalized, true);
    return base64_encode($digest);
}
function hawk_header(string $id, string $key, string $method, string $url, ?string $payload = null, string $contentType = 'application/json', string $algorithm = 'sha256'): string {
    $parts = parse_url($url);
    if (!$parts) throw new RuntimeException("Invalid URL for Hawk signing: {$url}");
    $host = $parts['host'] ?? '';
    $scheme = strtolower($parts['scheme'] ?? 'https');
    $port = $parts['port'] ?? ($scheme === 'https' ? 443 : 80);
    $path = $parts['path'] ?? '/';
    $query = isset($parts['query']) ? ('?' . $parts['query']) : '';
    $requestUri = $path . $query;
    $ts = (string) time();
    $nonce = bin2hex(random_bytes(6));
    $hash = null;
    if ($payload !== null && $payload !== '') $hash = hawk_payload_hash($payload, $contentType, $algorithm);
    $normalized = "hawk.1.header\n{$ts}\n{$nonce}\n".strtoupper($method)."\n{$requestUri}\n{$host}\n{$port}\n".($hash ?? '')."\n\n";
    $mac = base64_encode(hash_hmac($algorithm, $normalized, $key, true));
    $attrs = ['id'=>$id,'ts'=>$ts,'nonce'=>$nonce,'mac'=>$mac];
    if ($hash !== null) $attrs['hash'] = $hash;
    $pairs = []; foreach ($attrs as $k=>$v) $pairs[] = $k.'="'.str_replace(['\\','"'],['\\\\','\\"'],$v).'"';
    return 'Hawk ' . implode(', ', $pairs);
}
function sraps_request(string $method, string $url, string $accessId, string $secretKey, ?array $body = null): array {
    $payload = null; $contentType = 'application/json';
    if ($body !== null) $payload = json_encode($body, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
    $auth = hawk_header($accessId, $secretKey, $method, $url, $payload, $contentType);
    $headersOut = ['Authorization: '.$auth, 'Accept: application/json', 'User-Agent: SRAPS-PHP-Client/1.0'];
    if ($payload !== null) $headersOut[] = 'Content-Type: '.$contentType;
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, strtoupper($method));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headersOut);
    curl_setopt($ch, CURLOPT_HEADER, false);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
    if ($payload !== null) curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);
    $raw = curl_exec($ch);
    $errno = curl_errno($ch);
    $error = curl_error($ch);
    $status = (int) curl_getinfo($ch, CURLINFO_RESPONSE_CODE);
    curl_close($ch);
    if ($errno !== 0) throw new RuntimeException("Network error: {$error}");
    $decoded = null;
    if (is_string($raw) && $raw !== '') {
        $maybe = json_decode($raw, true);
        if (json_last_error() === JSON_ERROR_NONE) $decoded = $maybe;
    }
    if ($status < 200 || $status >= 300) {
        $msg = is_string($raw) ? $raw : '';
        throw new RuntimeException("SRAPS {$method} failed ({$status}): {$msg}");
    }
    return ['status'=>$status, 'data'=>$decoded !== null ? $decoded : $raw];
}
function sraps_company_url(array $conf): string {
    return rtrim($conf['baseUrl'] ?? 'https://api.sraps.snom.com/api/v1/', '/') . '/companies/' . rawurlencode((string)($conf['orgId'] ?? ''));
}
function sraps_test_connection(array &$wiz_sraps): array {
    $url = sraps_company_url($wiz_sraps);
    $resp = sraps_request('GET', $url, (string)$wiz_sraps['accessKey'], (string)$wiz_sraps['secretKey'], null);
    $wiz_sraps['statusOK'] = true; $wiz_sraps['statusAt'] = date('c');
    return $resp;
}
function sraps_pick_category(string $model): string {
    $up = strtoupper(trim($model));
    if (strpos($up, 'M500') === 0) return 'M500';
    if (strpos($up, 'M') === 0) return 'M';
    if (strpos($up, 'HOTEL') === 0) return 'HOTEL';
    return 'D';
}
function sraps_assign_device(array $wiz_sraps, string $macUpper, string $model, string $name = '', ?string $profileOverride = null): array {
    $mac = strtolower($macUpper);
    $profile = $profileOverride;
    if (!$profile) {
        $cat = sraps_pick_category($model);
        $profile = (string)($wiz_sraps['profilesCat'][$cat] ?? '');
        if ($profile === '') throw new RuntimeException("No SRAPS profile mapped for category {$cat}");
    }
    $endpointUrl = rtrim($wiz_sraps['baseUrl'], '/') . '/companies/' . rawurlencode((string)$wiz_sraps['orgId']) . '/endpoints/' . rawurlencode($mac);
    $payload = ['mac'=>$mac, 'autoprovisioning_enabled'=>true, 'provisioning_profile'=>$profile];
    if ($name !== '') $payload['name'] = $name;
    $resp = sraps_request('PUT', $endpointUrl, (string)$wiz_sraps['accessKey'], (string)$wiz_sraps['secretKey'], $payload);
    return $resp;
}

/* Robust profile list resolution */
function sraps_resolve_profiles_url(array $companyData, array $wiz_sraps): string {
    // Accept common shapes:
    // 1) links is an associative array with various key styles
    // 2) links is an array of {rel, href}
    $links = $companyData['links'] ?? null;
    $candidates = [];
    if (is_array($links)) {
        // Associative style
        foreach (['provisioning-profiles','provisioning_profiles','provisioningProfiles'] as $k) {
            if (isset($links[$k]) && is_string($links[$k]) && $links[$k] !== '') {
                $candidates[] = $links[$k];
            }
        }
        // Array of link objects
        if (array_keys($links) === range(0, count($links)-1)) {
            foreach ($links as $lnk) {
                if (is_array($lnk)) {
                    $rel = strtolower((string)($lnk['rel'] ?? ''));
                    $href = (string)($lnk['href'] ?? '');
                    if ($href && (strpos($rel, 'provision') !== false && strpos($rel, 'profile') !== false)) {
                        $candidates[] = $href;
                    }
                }
            }
        }
        // Any string value ending with /provisioning-profiles
        foreach ($links as $k=>$v) {
            if (is_string($v) && preg_match('#/provisioning-?profiles/?$#i', $v)) $candidates[] = $v;
        }
    }
    foreach ($candidates as $u) {
        if (is_string($u) && $u !== '') return $u;
    }
    // Fallback
    return rtrim($wiz_sraps['baseUrl'] ?? 'https://api.sraps.snom.com/api/v1/', '/') . '/companies/' . rawurlencode((string)($wiz_sraps['orgId'] ?? '')) . '/provisioning-profiles/';
}
function sraps_next_url($data): ?string {
    // Try common shapes for "next" pagination URL
    if (is_array($data)) {
        if (isset($data['next']) && is_string($data['next']) && $data['next'] !== '') return $data['next'];
        if (isset($data['links']['next']) && is_string($data['links']['next']) && $data['links']['next'] !== '') return $data['links']['next'];
        if (isset($data['next_page']) && is_string($data['next_page']) && $data['next_page'] !== '') return $data['next_page'];
    }
    return null;
}
function sraps_fetch_profiles(array $wiz_sraps): array {
    // 1) Get company to resolve link
    $compResp = sraps_request('GET', sraps_company_url($wiz_sraps), (string)$wiz_sraps['accessKey'], (string)$wiz_sraps['secretKey']);
    $company = is_array($compResp['data']) ? $compResp['data'] : [];
    $ppUrl = sraps_resolve_profiles_url($company, $wiz_sraps);
    // 2) Walk pages
    $out = []; $next = $ppUrl; $guard = 50;
    while ($next && $guard-- > 0) {
        $page = sraps_request('GET', $next, (string)$wiz_sraps['accessKey'], (string)$wiz_sraps['secretKey']);
        $data = $page['data'];
        if (isset($data['results']) && is_array($data['results'])) {
            $out = array_merge($out, $data['results']);
            $next = sraps_next_url($data);
        } elseif (is_array($data) && array_keys($data) === range(0, count($data)-1)) {
            $out = array_merge($out, $data);
            $next = null;
        } elseif (isset($data['items']) && is_array($data['items'])) {
            $out = array_merge($out, $data['items']);
            $next = sraps_next_url($data);
        } else {
            // Single object or unknown shape — push and stop
            $out[] = $data;
            $next = null;
        }
    }
    // Normalize minimal fields
    $norm = [];
    foreach ($out as $p) {
        if (!is_array($p)) continue;
        $uuid = (string)($p['uuid'] ?? ($p['uuid_v4'] ?? ($p['id'] ?? '')));
        $name = (string)($p['name'] ?? ($p['display_name'] ?? $uuid));
        if ($uuid !== '') $norm[] = ['uuid'=>$uuid, 'name'=>$name] + $p;
    }
    return $norm;
}

/* SRAPS AJAX entrypoint (inside this same file) */
if (isset($_GET['sraps_action'])) {
    header('Content-Type: application/json; charset=utf-8');
    $act = (string)$_GET['sraps_action'];
    $out = null; $code = 200;
    try {
        if ($act === 'status') {
            $out = [
                'configured' => ($wiz['sraps']['baseUrl'] ?? '') !== '' && ($wiz['sraps']['orgId'] ?? '') !== '' && ($wiz['sraps']['accessKey'] ?? '') !== '' && ($wiz['sraps']['secretKey'] ?? '') !== '',
                'statusOK'   => (bool)($wiz['sraps']['statusOK'] ?? false),
                'statusAt'   => (string)($wiz['sraps']['statusAt'] ?? ''),
                'baseUrl'    => (string)($wiz['sraps']['baseUrl'] ?? 'https://api.sraps.snom.com/api/v1/'),
                'profilesCat'=> (array)($wiz['sraps']['profilesCat'] ?? ['D'=>'','M'=>'','M500'=>'','HOTEL'=>'']),
            ];
        } elseif ($act === 'save_creds' && $_SERVER['REQUEST_METHOD']==='POST') {
            $raw = file_get_contents('php://input') ?: '';
            $in = json_decode($raw, true) ?: [];
            $base = rtrim((string)($in['baseUrl'] ?? 'https://api.sraps.snom.com/api/v1/'), '/') . '/';
            $org  = trim((string)($in['orgId'] ?? ''));
            $id   = trim((string)($in['accessKey'] ?? ''));
            $secret = isset($in['secretKey']) ? (string)$in['secretKey'] : null;

            // preserve secret when user sends sentinel '********' or omits field
            if ($secret === '********' || $secret === null) {
                $secretToStore = $wiz['sraps']['secretKey'] ?? '';
            } else {
                $secretToStore = $secret;
            }

            $wiz['sraps']['baseUrl'] = $base;
            $wiz['sraps']['orgId'] = $org;
            $wiz['sraps']['accessKey'] = $id;
            $wiz['sraps']['secretKey'] = $secretToStore;
            $wiz['sraps']['statusOK'] = false;
            $wiz['sraps']['statusAt'] = '';
            save_wiz_to_db($pdo,$sysId,$uid,$wiz);
            $out = ['ok'=>true];
        } elseif ($act === 'test') {
            $conf = $wiz['sraps'];
            if (($conf['baseUrl'] ?? '') === '' || ($conf['orgId'] ?? '') === '' || ($conf['accessKey'] ?? '') === '' || ($conf['secretKey'] ?? '') === '') {
                throw new RuntimeException('Missing SRAPS credentials');
            }
            try {
                $resp = sraps_test_connection($wiz['sraps']);
                save_wiz_to_db($pdo,$sysId,$uid,$wiz);
                $out = ['ok'=>true,'company'=>$resp['data']];
            } catch (Throwable $e) {
                $wiz['sraps']['statusOK'] = false; $wiz['sraps']['statusAt'] = date('c');
                save_wiz_to_db($pdo,$sysId,$uid,$wiz);
                throw $e;
            }
        } elseif ($act === 'get_profiles') {
            $profiles = sraps_fetch_profiles($wiz['sraps']);
            $out = ['profiles'=>$profiles];
        } elseif ($act === 'save_category_profiles' && $_SERVER['REQUEST_METHOD']==='POST') {
            $raw = file_get_contents('php://input') ?: '';
            $in = json_decode($raw, true) ?: [];
            $wiz['sraps']['profilesCat'] = [
                'D'     => (string)($in['profile_D'] ?? ''),
                'M'     => (string)($in['profile_M'] ?? ''),
                'M500'  => (string)($in['profile_M500'] ?? ''),
                'HOTEL' => (string)($in['profile_HOTEL'] ?? ''),
            ];
            save_wiz_to_db($pdo,$sysId,$uid,$wiz);
            $out = ['ok'=>true,'saved'=>$wiz['sraps']['profilesCat']];
        } elseif ($act === 'assign' && $_SERVER['REQUEST_METHOD']==='POST') {
            $raw = file_get_contents('php://input') ?: '';
            $in = json_decode($raw, true) ?: [];
            $mac = strtoupper(preg_replace('/[^A-Fa-f0-9]/','', (string)($in['mac'] ?? '')));
            $model = (string)($in['model'] ?? '');
            $name  = (string)($in['name'] ?? '');
            $prof  = isset($in['profileOverride']) ? (string)$in['profileOverride'] : null;
            if ($mac === '' || strlen($mac)!==12) throw new RuntimeException('mac must be 12 hex characters');
            $resp = sraps_assign_device($wiz['sraps'], $mac, $model, $name, $prof);
            $out = ['ok'=>true,'endpoint'=>$resp['data']];
        } else {
            $code = 400; $out = ['error'=>'Unknown action'];
        }
    } catch (Throwable $e) {
        $code = 500; $out = ['error'=>$e->getMessage()];
    }
    http_response_code($code);
    echo json_encode($out, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
    exit;
}

/* POST handlers */
if (isset($wiz['edit_ext'])) unset($wiz['edit_ext']);

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['open_global'])) {
    header('Location: extensions.php?system_id=' . (int)$sysId . '&global=1'); exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['assign']) && is_array($_POST['assign']) && !isset($_POST['generate_one']) && !isset($_POST['generate_selected']) && !isset($_POST['delete_generated']) && !isset($_POST['regenerate_all_existing'])) {
    $err = '';
    if (!merge_assign_into_session($_POST['assign'], $wiz, $err)) {
        $wiz['flash']=['msg'=>$err,'type'=>'warn']; save_wiz_to_db($pdo,$sysId,$uid,$wiz);
        header('Location: extensions.php?system_id=' . (int)$sysId); exit;
    }
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    $wiz['flash']=['msg'=>'Assignments saved.','type'=>'success']; save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    header('Location: extensions.php?system_id=' . (int)$sysId); exit;
}

/* Global Settings save - persist SRAPS flags and creds */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['save_global'])) {
    $incoming = (array)($_POST['global'] ?? []);
    $wiz['global'] = array_replace($wiz['global'], $incoming);

    // force_admin_password toggle may be present on Security tab
    if (!isset($incoming['force_admin_password'])) {
        $wiz['global']['force_admin_password'] = 'off';
    }
    // SRAPS flags
    if (!isset($incoming['use_sraps'])) {
        $wiz['global']['use_sraps'] = 'off';
    }
    if (!isset($incoming['sraps_push_on_generate'])) {
        $wiz['global']['sraps_push_on_generate'] = 'on'; // default to on
    }

    // SRAPS creds from Global panel (preserve secret if masked)
    $org = trim((string)($incoming['sraps_org'] ?? ''));
    $keyid = trim((string)($incoming['sraps_keyid'] ?? ''));
    $secret = array_key_exists('sraps_secret', $incoming) ? (string)$incoming['sraps_secret'] : null;
    if ($org !== '') $wiz['sraps']['orgId'] = $org;
    if ($keyid !== '') $wiz['sraps']['accessKey'] = $keyid;
    if ($secret !== null && $secret !== '' && $secret !== '********') $wiz['sraps']['secretKey'] = $secret;

    // Defaults and clamping
    if (empty($wiz['global']['setting_server'])) {
        $wiz['global']['setting_server'] = 'v2.6.1c/provisioning_files';
    }
    if (isset($wiz['global']['prov_polling_period'])) {
        $pp = (int)$wiz['global']['prov_polling_period'];
        if ($pp < 0) $pp = 0;
        if ($pp > 3600) $pp = 3600;
        $wiz['global']['prov_polling_period'] = (string)$pp;
    }
    if (!isset($wiz['global']['codec_priority_list'])) $wiz['global']['codec_priority_list'] = 'g722,pcmu,pcma,g729,telephone-event';
    if (!isset($wiz['global']['rtp_port_start'])) $wiz['global']['rtp_port_start'] = '49152';
    if (!isset($wiz['global']['rtp_port_end'])) $wiz['global']['rtp_port_end'] = '65534';

    $wiz['flash'] = ['msg'=>'Global settings saved.','type'=>'success'];
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    header('Location: extensions.php?system_id=' . (int)$sysId . '&global=1'); exit;
}

/* Save per-extension settings */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['save_settings']) && isset($_POST['ext'])) {
    $ext = (string)$_POST['ext'];
    $settings = $wiz['settings'][$ext] ?? [];

    if (isset($_POST['cfg_http_pass_real']) && trim((string)$_POST['cfg_http_pass_real']) !== '') {
        $settings['http_pass'] = trim((string)$_POST['cfg_http_pass_real']);
    } elseif (empty($settings['http_pass'])) {
        $settings['http_pass'] = random_password(16);
    }

    if (isset($_POST['cfg_user_http_pass']) && trim((string)$_POST['cfg_user_http_pass']) !== '') {
        $settings['user_http_pass'] = trim((string)$_POST['cfg_user_http_pass']);
    }

    $blf=[]; $types=$_POST['cfg_blf_type']??[]; $exts_b=$_POST['cfg_blf_ext']??[]; $vals=$_POST['cfg_blf_value']??[]; $labs=$_POST['cfg_blf_label']??[];
    $max=max(count($types),count($exts_b),count($vals),count($labs));
    global $fullname_by_ext;
    for($i=1;$i<=$max;$i++){
        $t=trim((string)($types[$i]??'blf'));
        $ev=trim((string)($exts_b[$i]??'')); $vv=trim((string)($vals[$i]??'')); $ll=sanitize_for_ui((string)($labs[$i]??''));
        if($t==='none') continue;
        $val = ($ev !== '' ? $ev : $vv);
        if($val==='') continue;
        if ($ll === '') { $nm = $fullname_by_ext[$val] ?? ''; $ll = $nm !== '' ? $nm : $val; }
        $blf[]=['type'=>'blf','value'=>$val,'label'=>$ll];
    }

    $model_for_ext = $wiz['assign'][$ext]['model'] ?? '';
    $cap = fkey_cap_for_model((string)$model_for_ext);
    if (count($blf) > $cap) {
        $blf = array_slice($blf, 0, $cap);
        $wiz['flash'] = ['msg' => "F-keys limited to {$cap} for model ".(($model_for_ext?:'Unknown')).". Excess removed.", 'type' => 'warn'];
    }
    $settings['__blf'] = $blf;

    $settings['custom_xml'] = (string)($_POST['cfg']['custom_xml'] ?? ($settings['custom_xml'] ?? ''));

    $wiz['settings'][$ext] = $settings;
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    if (empty($wiz['flash'])) $wiz['flash']=['msg'=>"Settings saved for {$ext}.",'type'=>'success'];
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    header('Location: extensions.php?system_id='.(int)$sysId.'&edit='.urlencode($ext)); exit;
}

/* Generate one - optionally push to SRAPS */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['generate_one']) && $_POST['generate_one']!=='') {
    if (isset($_POST['assign']) && is_array($_POST['assign'])) { $err=''; if (!merge_assign_into_session($_POST['assign'], $wiz, $err)) { $wiz['flash']=['msg'=>$err,'type'=>'warn']; save_wiz_to_db($pdo,$sysId,$uid,$wiz); header('Location: extensions.php?system_id='.(int)$sysId); exit; } save_wiz_to_db($pdo,$sysId,$uid,$wiz); }
    $ext=(string)$_POST['generate_one']; $found=null; foreach($exts as $e) if((string)$e['extension']===$ext){ $found=$e; break; }
    if(!$found){ $wiz['flash']=['msg'=>"Extension {$ext} not found.",'type'=>'warn']; save_wiz_to_db($pdo,$sysId,$uid,$wiz); header('Location: extensions.php?system_id='.(int)$sysId); exit; }
    $mac = $wiz['assign'][$ext]['mac'] ?? '';
    if ($mac===''){ $wiz['flash']=['msg'=>"No MAC assigned for {$ext}.",'type'=>'warn']; save_wiz_to_db($pdo,$sysId,$uid,$wiz); header('Location: extensions.php?system_id='.(int)$sysId); exit; }
    if (!is_valid_mac($mac)) { $wiz['flash']=['msg'=>"Invalid MAC for {$ext}. Expect 12 hex characters (0-9,A-F).",'type'=>'warn']; save_wiz_to_db($pdo,$sysId,$uid,$wiz); header('Location: extensions.php?system_id='.(int)$sysId); exit; }
    $over = $wiz['settings'][$ext] ?? [];
    if (empty($over['http_pass'])) { $over['http_pass'] = random_password(16); $wiz['settings'][$ext]['http_pass'] = $over['http_pass']; }
    if (empty($over['user_http_pass'])) { $over['user_http_pass'] = random_password(16); $wiz['settings'][$ext]['user_http_pass'] = $over['user_http_pass']; }
    $over['__model'] = $wiz['assign'][$ext]['model'] ?? '';
    $global = $wiz['global'] ?? [];
    $merged = array_merge($global, $over);
    if (empty($merged['setting_server'])) $merged['setting_server'] = 'v2.6.1c/provisioning_files';
    $oldfile = rtrim($PROVISION_DIR,'/')."/{$mac}.xml"; if (file_exists($oldfile)) @unlink($oldfile);
    [$ok,$res] = write_profile($PROVISION_DIR, $sys['host'], $found, $mac, $merged, $exts);

    $msgParts=[]; $type='success';
    if ($ok) {
        $wiz['generated'][$ext]=['mac'=>$res,'url'=>$PUBLIC_PROVISION_PATH.'/'.$res.'.xml','created'=>date('c')];
        $msgParts[] = "Generated profile for {$ext}.";
        $useSRAPS = (($wiz['global']['use_sraps'] ?? 'off') === 'on');
        $pushOnGen = (($wiz['global']['sraps_push_on_generate'] ?? 'on') === 'on');
        if ($useSRAPS && $pushOnGen && !empty($wiz['sraps']['statusOK'])) {
            try {
                $model = (string)($wiz['assign'][$ext]['model'] ?? '');
                $name  = (string)($found['fullname'] ?? '');
                sraps_assign_device($wiz['sraps'], $res, $model, $name, null);
                $msgParts[] = "SRAPS: device assigned";
            } catch (Throwable $se) {
                $msgParts[] = "SRAPS failed: ".$se->getMessage();
                $type='warn';
            }
        }
    } else {
        $msgParts[] = "Failed generating {$ext}: {$res}";
        $type='warn';
    }
    $wiz['flash']=['msg'=>implode(' ', $msgParts),'type'=>$type];
    save_wiz_to_db($pdo,$sysId,$uid,$wiz); header('Location: extensions.php?system_id='.(int)$sysId); exit;
}

/* Generate selected (bulk) */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['generate_selected']) && is_array($_POST['generate_selected'])) {
    if (isset($_POST['assign']) && is_array($_POST['assign'])) { $err=''; if (!merge_assign_into_session($_POST['assign'], $wiz, $err)) { $wiz['flash']=['msg'=>$err,'type'=>'warn']; save_wiz_to_db($pdo,$sysId,$uid,$wiz); header('Location: extensions.php?system_id='.(int)$sysId); exit; } save_wiz_to_db($pdo,$sysId,$uid,$wiz); }
    $selected = $_POST['generate_selected']; $count=0; $errors=[]; $global = $wiz['global'] ?? [];
    $useSRAPS = (($wiz['global']['use_sraps'] ?? 'off') === 'on');
    $pushOnGen = (($wiz['global']['sraps_push_on_generate'] ?? 'on') === 'on');
    foreach($selected as $ext) {
        $ext=(string)$ext; $found=null; foreach($exts as $e) if((string)$e['extension']===$ext){ $found=$e; break; }
        if(!$found){ $errors[]="Not found {$ext}"; continue; }
        $mac = $wiz['assign'][$ext]['mac'] ?? '';
        if ($mac===''){ $errors[]="No MAC for {$ext}"; continue; }
        if (!is_valid_mac($mac)) { $errors[]="Invalid MAC for {$ext}: must be 12 hex chars (0-9,A-F)"; continue; }
        $over = $wiz['settings'][$ext] ?? [];
        if (empty($over['http_pass'])) { $over['http_pass'] = random_password(16); $wiz['settings'][$ext]['http_pass'] = $over['http_pass']; }
        if (empty($over['user_http_pass'])) { $over['user_http_pass'] = random_password(16); $wiz['settings'][$ext]['user_http_pass'] = $over['user_http_pass']; }
        $over['__model'] = $wiz['assign'][$ext]['model'] ?? '';
        $merged = array_merge($global, $over);
        if (empty($merged['setting_server'])) $merged['setting_server'] = 'v2.6.1c/provisioning_files';
        $oldfile = rtrim($PROVISION_DIR,'/')."/{$mac}.xml"; if (file_exists($oldfile)) @unlink($oldfile);
        [$ok,$res] = write_profile($PROVISION_DIR, $sys['host'], $found, $mac, $merged, $exts);
        if ($ok) {
            $wiz['generated'][$ext]=['mac'=>$res,'url'=>$PUBLIC_PROVISION_PATH.'/'.$res.'.xml','created'=>date('c')];
            $count++;
            if ($useSRAPS && $pushOnGen && !empty($wiz['sraps']['statusOK'])) {
                try {
                    sraps_assign_device($wiz['sraps'], $res, ($wiz['assign'][$ext]['model'] ?? ''), ($found['fullname'] ?? ''));
                } catch (Throwable $se) {
                    $errors[] = "SRAPS {$ext}: ".$se->getMessage();
                }
            }
        } else $errors[]="Failed {$ext}: {$res}";
    }
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    $msg = "Generated {$count} profiles."; if (!empty($errors)) $msg .= ' Errors: '.implode('; ',$errors);
    $wiz['flash']=['msg'=>$msg,'type'=>$count ? 'success' : 'warn'];
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    header('Location: extensions.php?system_id='.(int)$sysId); exit;
}

/* Regenerate all existing */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['regenerate_all_existing'])) {
    $existing = array_keys($wiz['generated'] ?? []);
    if (empty($existing)) { $wiz['flash']=['msg'=>'No existing generated files to regenerate.','type'=>'warn']; save_wiz_to_db($pdo,$sysId,$uid,$wiz); header('Location: extensions.php?system_id='.(int)$sysId); exit; }
    $count=0; $errors=[]; $global = $wiz['global'] ?? [];
    $useSRAPS = (($wiz['global']['use_sraps'] ?? 'off') === 'on');
    $pushOnGen = (($wiz['global']['sraps_push_on_generate'] ?? 'on') === 'on');
    foreach($existing as $ext) {
        $ext=(string)$ext; $found=null; foreach($exts as $e) if((string)$e['extension']===$ext){ $found=$e; break; }
        if(!$found){ $errors[]="Not found {$ext}"; continue; }
        $mac = $wiz['assign'][$ext]['mac'] ?? ($wiz['generated'][$ext]['mac'] ?? '');
        if ($mac===''){ $errors[]="No MAC for {$ext}"; continue; }
        if (!is_valid_mac($mac)) { $errors[]="Invalid MAC for {$ext}"; continue; }
        $over = $wiz['settings'][$ext] ?? [];
        if (empty($over['http_pass'])) { $over['http_pass'] = random_password(16); $wiz['settings'][$ext]['http_pass'] = $over['http_pass']; }
        if (empty($over['user_http_pass'])) { $over['user_http_pass'] = random_password(16); $wiz['settings'][$ext]['user_http_pass'] = $over['user_http_pass']; }
        $over['__model'] = $wiz['assign'][$ext]['model'] ?? '';
        $merged = array_merge($global, $over);
        if (empty($merged['setting_server'])) $merged['setting_server'] = 'v2.6.1c/provisioning_files';
        $oldfile = rtrim($PROVISION_DIR,'/')."/{$mac}.xml"; if (file_exists($oldfile)) @unlink($oldfile);
        [$ok,$res] = write_profile($PROVISION_DIR, $sys['host'], $found, $mac, $merged, $exts);
        if ($ok) {
            $wiz['generated'][$ext]=['mac'=>$res,'url'=>$PUBLIC_PROVISION_PATH.'/'.$res.'.xml','created'=>date('c')];
            $count++;
            if ($useSRAPS && $pushOnGen && !empty($wiz['sraps']['statusOK'])) {
                try {
                    sraps_assign_device($wiz['sraps'], $res, ($wiz['assign'][$ext]['model'] ?? ''), ($found['fullname'] ?? ''));
                } catch (Throwable $se) {
                    $errors[] = "SRAPS {$ext}: ".$se->getMessage();
                }
            }
        } else $errors[]="Failed {$ext}: {$res}";
    }
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    $msg = "Regenerated {$count} profiles."; if (!empty($errors)) $msg .= ' Errors: '.implode('; ',$errors);
    $wiz['flash']=['msg'=>$msg,'type'=>$count ? 'success' : 'warn'];
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    header('Location: extensions.php?system_id='.(int)$sysId); exit;
}

/* Delete generated file */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_generated']) && $_POST['delete_generated']!=='') {
    $ext = (string)$_POST['delete_generated'];
    $gen = $wiz['generated'][$ext] ?? null;
    if (!$gen) {
        $wiz['flash']=['msg'=>"No generated file found for {$ext}.",'type'=>'warn'];
    } else {
        $mac = $gen['mac'] ?? '';
        if ($mac) {
            $file = rtrim($PROVISION_DIR,'/')."/{$mac}.xml";
            if (file_exists($file)) { @unlink($file); }
        }
        unset($wiz['generated'][$ext]);
        $wiz['flash']=['msg'=>"Deleted provisioning file for {$ext}.",'type'=>'success'];
    }
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
    header('Location: extensions.php?system_id='.(int)$sysId); exit;
}

/* Client-side data */
$mac_list_for_js = [];
if (!empty($_SESSION['mac_list']) && is_array($_SESSION['mac_list'])) foreach($_SESSION['mac_list'] as $mac=>$info) $mac_list_for_js[]=$info;
$mac_list_json = json_encode($mac_list_for_js, JSON_HEX_TAG|JSON_HEX_APOS|JSON_HEX_AMP|JSON_HEX_QUOT);
$assigned_macs = []; foreach ($wiz['assign'] as $aext=>$adata) { $am = normalize_mac((string)$adata['mac']); if ($am!=='') $assigned_macs[$am] = $aext; }
$assigned_macs_json = json_encode($assigned_macs, JSON_HEX_TAG|JSON_HEX_APOS|JSON_HEX_AMP|JSON_HEX_QUOT);

/* flash -> toast */
$toast_msg = ''; $toast_type = 'success';
if (!empty($wiz['flash']) && is_array($wiz['flash'])) {
    $toast_msg = sanitize_for_ui($wiz['flash']['msg'] ?? '');
    $toast_msg = preg_replace('/\?+\s*$/', '', $toast_msg);
    $toast_type = $wiz['flash']['type'] ?? 'success';
    $wiz['flash'] = null;
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
}

/* open modals via GET */
$show_edit_ext = null;
if (isset($_GET['edit']) && trim((string)$_GET['edit']) !== '') $show_edit_ext = sanitize_for_ui((string)$_GET['edit']);
$show_global = (isset($_GET['global']) && (string)$_GET['global'] === '1');

/* Ensure passwords exist on Edit open */
if (!empty($show_edit_ext)) {
    $ext = $show_edit_ext;
    if (!isset($wiz['settings'][$ext])) $wiz['settings'][$ext] = [];
    if (empty($wiz['settings'][$ext]['http_pass'])) {
        $wiz['settings'][$ext]['http_pass'] = random_password(16);
    }
    if (empty($wiz['settings'][$ext]['user_http_pass'])) {
        $wiz['settings'][$ext]['user_http_pass'] = random_password(16);
    }
    save_wiz_to_db($pdo,$sysId,$uid,$wiz);
}

/* Extension -> fullname map for JS */
$ext_to_fullname = [];
foreach ($exts as $row) {
    $ee = (string)($row['extension'] ?? '');
    $nm = sanitize_for_ui((string)($row['fullname'] ?? ''));
    if ($ee !== '') $ext_to_fullname[$ee] = $nm;
}
$ext_to_fullname_json = json_encode($ext_to_fullname, JSON_HEX_TAG|JSON_HEX_APOS|JSON_HEX_AMP|JSON_HEX_QUOT);

/* Locale list (subset) */
$localeCodes = array_unique([
  "en_US","en_GB","en_CA","en_AU","fr_FR","fr_CA","es_ES","es_MX","de_DE","it_IT",
  "pt_PT","pt_BR","nl_NL","sv_SE","no_NO","da_DK","fi_FI","pl_PL","cs_CZ","sk_SK",
  "sl_SI","hu_HU","ro_RO","bg_BG","el_GR","tr_TR","ru_RU","uk_UA","ar_SA","he_IL",
  "zh_CN","zh_TW","ja_JP","ko_KR"
]);

/* Render */
$title_safe = sanitize_for_ui((string)($sys['label'] ?? 'Provisioning'));
?>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title><?= e($title_safe) ?> - Extensions</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f7fb;--card:#fff;--muted:#5b6472;--ink:#0d1321;--accent:#2f3bd6;--accent-2:#0ea5e9;--danger:#dc2626;
  --border:#e6eaf2;--tab:#eef2ff;--radius:12px;--shadow:0 10px 30px rgba(2,6,23,0.08)
}
*{box-sizing:border-box}
body{background:var(--bg);margin:18px;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--ink)}
.container{max-width:1220px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{height:48px;width:auto;border-radius:10px;padding:6px;background:#fff;object-fit:contain;border:1px solid var(--border)}
.small{font-size:13px;color:var(--muted)}
.btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:8px 10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600;font-size:12px}
.btn.secondary{background:#334155}
.btn.warn{background:var(--danger)}
.btn.ghost{background:#eef2ff;color:#0b2548}
.btn.inline{padding:6px 9px}
.header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.table{margin-top:14px;border-radius:14px;overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--border);background:var(--card)}
.table table{width:100%;border-collapse:collapse}
.table th, .table td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
.table thead th{background:#fafcff; text-align:left}
.macs-input, select[name$="[model]"], .small-input, select.small-input{height:30px;padding:6px 8px;border-radius:10px;border:1px solid var(--border);font-size:12px;background:#fff;width:100%}
.mac-combo-input{width:220px;text-transform:uppercase}
.row-actions{display:flex;gap:8px;align-items:center;white-space:nowrap}
.sel-chk{width:18px;height:18px;margin:0}
.modal-card{width:920px;max-width:100%;max-height:92vh;overflow:auto;background:var(--card);border-radius:16px;padding:18px;box-shadow:0 40px 90px rgba(2,6,23,0.18);border:1px solid var(--border)}
.tabs{display:flex;gap:6px;border-bottom:1px solid var(--border);margin-bottom:12px;flex-wrap:nowrap;white-space:nowrap;overflow:visible}
.tab{padding:6px 9px;border-radius:10px 10px 0 0;background:var(--tab);cursor:pointer;color:#0b2548;font-weight:600;flex:0 0 auto;font-size:12px}
.tab.active{background:#fff;border:1px solid var(--border);border-bottom-color:#fff}
.tabpanel{display:none}
.tabpanel.active{display:block}
.form-grid{display:grid;grid-template-columns:200px 1fr;gap:8px 12px;align-items:center}
.form-grid .label{color:#475569;font-size:12px}
.form-grid .value{width:100%}
.area{width:100%;min-height:120px;padding:8px;border:1px solid var(--border);border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
.section-card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
.group-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
.mac-combo{position:relative;display:inline-block}
.mac-combo-list{position:absolute;left:0;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--border);border-radius:10px;max-height:220px;overflow:auto;z-index:120;box-shadow:var(--shadow);display:none}
.mac-combo-item{padding:8px 10px;border-bottom:1px solid var(--border);cursor:pointer;font-family:monospace}
.mac-combo-item:hover,.mac-combo-item.active{background:#f1f7ff}
.mac-combo-empty{padding:8px 10px;color:#64748b}
.actions-bar{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;white-space:nowrap;overflow-x:auto;padding-bottom:2px}
.search-input{height:30px;padding:6px 8px;border:1px solid var(--border);border-radius:10px;font-size:12px;width:240px;min-width:180px}

/* quick toast */
.center-toast-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.05);z-index:99999}
.center-toast{display:flex;align-items:center;gap:12px;background:#111827;color:#fff;border-radius:10px;padding:12px 14px;box-shadow:0 10px 30px rgba(0,0,0,.25);max-width:80vw}
.center-toast.warn{background:#b45309}
.close-btn{appearance:none;border:0;background:transparent;color:#fff;font-size:20px;cursor:pointer}
.hint{font-size:12px;color:#64748b}
.sraps-grid{display:grid;grid-template-columns:180px 1fr;gap:8px 12px;align-items:center}
</style>
<?php
$themeRel = 'assets/css/theme-snom.css';
$themeAbs = __DIR__ . '/' . $themeRel;
$baseDir = isset($_SERVER['SCRIPT_NAME']) ? rtrim(dirname($_SERVER['SCRIPT_NAME']), '/') : '';
$themeHref = ($baseDir === '' ? '' : $baseDir . '/') . $themeRel;
if (!file_exists($themeAbs) && isset($_SERVER['DOCUMENT_ROOT']) && is_file($_SERVER['DOCUMENT_ROOT'] . '/assets/css/theme-snom.css')) {
    $themeHref = '/assets/css/theme-snom.css';
    $themeAbs = $_SERVER['DOCUMENT_ROOT'] . '/assets/css/theme-snom.css';
}
$themeVer = file_exists($themeAbs) ? (int)filemtime($themeAbs) : time();
?>
<link rel="stylesheet" href="<?= e($themeHref) ?>?v=<?= $themeVer ?>">
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <img id="site-logo" src="<?= e($logo_src) ?>" class="logo" alt="logo" onerror="this.onerror=null;this.src='<?= e($local_logo_path) ?>';">
      <div>
        <div style="font-weight:700"><?= e($title_safe) ?></div>
        <div class="small">Host: <?= e((string)$sys['host'] ?? '') ?></div>
      </div>
    </div>

    <div class="header-actions">
      <button id="open-sraps" class="btn inline" type="button" title="SRAPS">SRAPS</button>
      <button class="btn secondary inline" type="button" onclick="document.getElementById('switch-site-modal').style.display='flex'">Switch Site</button>
      <a href="logout.php" class="btn warn inline" style="text-decoration:none">Logout</a>
      <form method="post" style="margin:0"><input type="hidden" name="fetch_ucm" value="1"><button class="btn secondary inline" type="submit">Refresh Extensions</button></form>
      <form method="post" style="margin:0"><input type="hidden" name="regenerate_all_existing" value="1"><button class="btn inline" type="submit">Regenerate All Existing</button></form>
      <form method="post" enctype="multipart/form-data" style="margin:0;display:inline-flex;align-items:center;gap:6px">
        <input type="file" name="mac_csv" accept=".csv">
        <button class="btn inline" type="submit">Upload CSV</button>
      </form>
    </div>
  </div>

  <?php if (!empty($csv_msg)): ?><div style="margin-top:6px" class="small"><?= e($csv_msg) ?></div><?php endif; ?>

  <div style="margin-top:12px;">
    <div class="actions-bar">
      <form method="post" style="margin:0;display:inline">
        <button class="btn inline" type="submit" name="open_global" value="1">Global Settings</button>
      </form>
      <button class="btn inline" id="save-assignments-btn" type="button" onclick="document.getElementById('assign-form').submit()">Save Assignments</button>
      <button class="btn inline" type="button" onclick="location.href='d7xx.php?system_id=<?= (int)$sysId ?>'">D7xx Series</button>
      <button class="btn inline" type="button" onclick="location.href='dect.php?system_id=<?= (int)$sysId ?>'">DECT</button>
      <button class="btn inline" type="button" onclick="location.href='m500.php?system_id=<?= (int)$sysId ?>'">M500</button>
      <button class="btn inline" type="button" onclick="location.href='hotel.php?system_id=<?= (int)$sysId ?>'">Hotel Phones</button>
      <input id="search-all" class="search-input" type="text" placeholder="Search name, ext, MAC, model" aria-label="Search">
      <button id="search-btn" class="btn inline" type="button">Search</button>
    </div>
  </div>

  <div class="table" style="margin-top:12px">
    <form method="post" id="assign-form">
      <table id="ext-table">
        <thead><tr><th></th><th style="width:120px">Extension</th><th>Fullname</th><th style="width:260px">MAC</th><th style="width:180px">Model</th><th style="width:320px">Actions</th></tr></thead>
        <tbody>
        <?php if (!empty($exts)): foreach ($exts as $r):
          $ext = sanitize_for_ui((string)$r['extension']);
          $full = sanitize_for_ui((string)$r['fullname']);
          $macVal = $wiz['assign'][$ext]['mac'] ?? ''; $modelVal = $wiz['assign'][$ext]['model'] ?? ''; $isGen = isset($wiz['generated'][$ext]);
          $comboId = 'mac_combo_'.preg_replace('/[^A-Za-z0-9_-]/','_',$ext);
        ?>
          <tr>
            <td><input type="checkbox" class="sel-chk" value="<?= e($ext) ?>"></td>
            <td class="col-ext"><?= e($ext) ?></td>
            <td class="col-full"><?= e($full) ?></td>
            <td class="col-mac">
              <div class="mac-combo" data-ext="<?= e($ext) ?>">
                <input type="text" name="assign[<?= e($ext) ?>][mac]" value="<?= e($macVal) ?>" class="mac-combo-input macs-input" data-combo-id="<?= e($comboId) ?>" placeholder="AABBCCDDEEFF" maxlength="17" autocomplete="off" aria-label="MAC for <?= e($ext) ?>">
                <div class="mac-combo-list" id="<?= e($comboId) ?>" role="listbox" aria-label="MAC suggestions"></div>
              </div>
            </td>
            <td class="col-model">
              <select name="assign[<?= e($ext) ?>][model]" class="small-input">
                <option value="">Select</option>
                <?php foreach (['D862','D865','D895','D892'] as $m) { $sel = ($modelVal === $m) ? 'selected' : ''; echo "<option value=\"".e($m)."\" $sel>".e($m)."</option>"; } ?>
              </select>
            </td>
            <td>
              <div class="row-actions" role="group">
                <button class="btn inline" type="button" onclick="postGenerate('<?= e($ext) ?>')"><?= $isGen ? 'Regenerate' : 'Generate' ?></button>
                <button class="btn secondary inline" type="button" onclick="postEdit('<?= e($ext) ?>')">Edit</button>
                <?php if ($isGen): $url = $wiz['generated'][$ext]['url'] ?? ''; if ($url): ?>
                  <a class="btn secondary inline" href="<?= e($url) ?>" target="_blank" rel="noopener noreferrer">Download</a>
                <?php endif; ?>
                  <button type="button" class="btn warn inline" onclick="confirmDelete('<?= e($ext) ?>')">Delete File</button>
                <?php endif; ?>
              </div>
            </td>
          </tr>
        <?php endforeach; else: ?>
          <tr><td colspan="6" class="small">No extensions found. Use Refresh Extensions to fetch from UCM.</td></tr>
        <?php endif; ?>
        </tbody>
      </table>
    </form>
  </div>
</div>

<!-- Switch Site modal -->
<div id="switch-site-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9998">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="switch-site-title" style="max-width:520px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 id="switch-site-title" style="margin:0">Switch Site</h3>
      <div><button type="button" class="btn secondary inline" onclick="document.getElementById('switch-site-modal').style.display='none'">Close</button></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <label>Choose a site
        <select id="switch-site-select" class="small-input" style="width:100%">
          <?php if (!empty($sites)): foreach ($sites as $s): ?>
            <option value="<?= (int)$s['id'] ?>" <?= ((int)$s['id'] === (int)$sysId) ? 'selected' : '' ?>>
              <?= e($s['label']) ?> <?= $s['host'] ? '(' . e($s['host']) . ')' : '' ?>
            </option>
          <?php endforeach; else: ?>
            <option value="">No sites found</option>
          <?php endif; ?>
        </select>
      </label>
      <div style="text-align:right">
        <button type="button" class="btn secondary inline" onclick="document.getElementById('switch-site-modal').style.display='none'">Cancel</button>
        <button type="button" class="btn inline" onclick="switchSiteGo()">Go</button>
      </div>
    </div>
  </div>
</div>

<!-- Global Settings modal -->
<?php if ($show_global): ?>
<div id="global-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9998">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="global-modal-title" style="max-width:920px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 id="global-modal-title" style="margin:0;font-size:16px">Global Settings</h3>
      <div><a class="btn secondary inline" href="extensions.php?system_id=<?=
        (int)$sysId ?>" style="text-decoration:none">Close</a></div>
    </div>

    <div class="tabs">
      <div class="tab" data-tab="tab-loc">Localization</div>
      <div class="tab" data-tab="tab-contacts">Contact List</div>
      <div class="tab" data-tab="tab-maint">Maintenance</div>
      <div class="tab" data-tab="tab-net">Network</div>
      <div class="tab" data-tab="tab-sec">Security</div>
      <div class="tab" data-tab="tab-prov">Provisioning</div>
      <div class="tab" data-tab="tab-call">Call Features</div>
      <div class="tab" data-tab="tab-custom">Custom XML</div>
      <div class="tab active" data-tab="tab-sraps">SRAPS</div>
    </div>

    <form method="post" style="display:block">
      <!-- Localization -->
      <div id="tab-loc" class="tabpanel">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">LCD language</div>
            <div class="value">
              <select name="global[loc_lcd_language]" class="small-input">
                <option value="">System default</option>
                <?php foreach ($localeCodes as $lc): $sel = (($wiz['global']['loc_lcd_language'] ?? '')===$lc)?'selected':''; ?>
                  <option value="<?= e($lc) ?>" <?= $sel ?>><?= e($lc) ?></option>
                <?php endforeach; ?>
              </select>
            </div>
            <div class="label">Web UI language</div>
            <div class="value"><input class="small-input" name="global[loc_web_language]" value="<?= e($wiz['global']['loc_web_language'] ?? '') ?>" placeholder="en_US"></div>
            <div class="label">Locale</div>
            <div class="value"><input class="small-input" name="global[loc_locale]" value="<?= e($wiz['global']['loc_locale'] ?? '') ?>" placeholder="en_US"></div>
            <div class="label">Timezone</div>
            <div class="value"><input class="small-input" name="global[loc_timezone]" value="<?= e($wiz['global']['loc_timezone'] ?? '') ?>" placeholder="UTC"></div>
          </div>
        </div>
      </div>

      <!-- Contacts -->
      <div id="tab-contacts" class="tabpanel">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">Directory URL</div>
            <div class="value"><input class="small-input" name="global[contacts_tbook_url]" value="<?= e($wiz['global']['contacts_tbook_url'] ?? '') ?>" placeholder="http(s)://..."></div>
            <div class="label">LDAP enabled</div>
            <div class="value"><input type="checkbox" name="global[contacts_ldap_enable]" value="on" <?= (($wiz['global']['contacts_ldap_enable'] ?? 'off')==='on')?'checked':'' ?>></div>
          </div>
        </div>
      </div>

      <!-- Maintenance -->
      <div id="tab-maint" class="tabpanel">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">Syslog server</div>
            <div class="value"><input class="small-input" name="global[syslog_server]" value="<?= e($wiz['global']['syslog_server'] ?? '') ?>"></div>
            <div class="label">Firmware URL (model-specific)</div>
            <div class="value"><input class="small-input" name="global[maint_fw_D862]" value="<?= e($wiz['global']['maint_fw_D862'] ?? '') ?>" placeholder="D862 firmware URL"></div>
            <div class="label"></div>
            <div class="value"><input class="small-input" name="global[maint_fw_D865]" value="<?= e($wiz['global']['maint_fw_D865'] ?? '') ?>" placeholder="D865 firmware URL"></div>
          </div>
        </div>
      </div>

      <!-- Network -->
      <div id="tab-net" class="tabpanel">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">SIP transport</div>
            <div class="value">
              <select name="global[sec_sip_transport]" class="small-input">
                <?php foreach (['udp','tcp','tls'] as $t): $sel=(($wiz['global']['sec_sip_transport'] ?? 'udp')===$t)?'selected':''; ?>
                  <option value="<?= e($t) ?>" <?= $sel ?>><?= strtoupper(e($t)) ?></option>
                <?php endforeach; ?>
              </select>
            </div>
            <div class="label">LAN VLAN</div>
            <div class="value"><input class="small-input" name="global[net_vlan_lan]" value="<?= e($wiz['global']['net_vlan_lan'] ?? '') ?>" placeholder="e.g. 20"></div>
            <div class="label">PC VLAN</div>
            <div class="value"><input class="small-input" name="global[net_vlan_pc]" value="<?= e($wiz['global']['net_vlan_pc'] ?? '') ?>" placeholder="e.g. 10"></div>
            <div class="label">DSCP SIP</div>
            <div class="value"><input class="small-input" name="global[net_dscp_sip]" value="<?= e($wiz['global']['net_dscp_sip'] ?? '') ?>" placeholder="46"></div>
            <div class="label">DSCP RTP</div>
            <div class="value"><input class="small-input" name="global[net_dscp_rtp]" value="<?= e($wiz['global']['net_dscp_rtp'] ?? '') ?>" placeholder="46"></div>
          </div>
        </div>
      </div>

      <!-- Security -->
      <div id="tab-sec" class="tabpanel">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">Force admin password</div>
            <div class="value">
              <input type="checkbox" id="force_admin_password" name="global[force_admin_password]" value="on" <?= (($wiz['global']['force_admin_password'] ?? 'off')==='on')?'checked':'' ?>>
            </div>
            <div class="label">Forced admin password</div>
            <div class="value">
              <input class="small-input" id="forced_admin_password" name="global[forced_admin_password]" value="<?= e($wiz['global']['forced_admin_password'] ?? '') ?>" <?= (($wiz['global']['force_admin_password'] ?? 'off')==='on')?'':'disabled' ?>>
            </div>
          </div>
        </div>
      </div>

      <!-- Provisioning -->
      <div id="tab-prov" class="tabpanel">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">Setting server URL</div>
            <div class="value"><input class="small-input" name="global[setting_server]" value="<?= e($wiz['global']['setting_server'] ?? 'v2.6.1c/provisioning_files') ?>" placeholder="v2.6.1c/provisioning_files"></div>
            <div class="label">Polling period (sec)</div>
            <div class="value"><input class="small-input" type="number" min="0" max="3600" name="global[prov_polling_period]" value="<?= e($wiz['global']['prov_polling_period'] ?? '0') ?>"></div>
          </div>
        </div>
      </div>

      <!-- Call Features -->
      <div id="tab-call" class="tabpanel">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">Codec priority list</div>
            <div class="value"><input class="small-input" name="global[codec_priority_list]" value="<?= e($wiz['global']['codec_priority_list'] ?? 'g722,pcmu,pcma,g729,telephone-event') ?>"></div>
            <div class="label">RTP port start</div>
            <div class="value"><input class="small-input" type="number" name="global[rtp_port_start]" value="<?= e($wiz['global']['rtp_port_start'] ?? '49152') ?>"></div>
            <div class="label">RTP port end</div>
            <div class="value"><input class="small-input" type="number" name="global[rtp_port_end]" value="<?= e($wiz['global']['rtp_port_end'] ?? '65534') ?>"></div>
            <div class="label">Voicemail key</div>
            <div class="value"><input class="small-input" name="global[vm_key]" value="<?= e($wiz['global']['vm_key'] ?? '') ?>" placeholder="Ext for voicemail"></div>
            <div class="label">Call waiting</div>
            <div class="value"><input type="checkbox" name="global[call_waiting]" value="on" <?= (($wiz['global']['call_waiting'] ?? 'on')==='on')?'checked':'' ?>></div>
          </div>
        </div>
      </div>

      <!-- Custom XML (global) -->
      <div id="tab-custom" class="tabpanel">
        <div class="section-card">
          <textarea class="area" name="global[custom_xml_global]" placeholder="Custom XML under <phone-settings> (global)"><?=
            htmlspecialchars((string)($wiz['global']['custom_xml_global'] ?? ''), ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8')
          ?></textarea>
        </div>
      </div>

      <!-- SRAPS panel (active by default so details show) -->
      <div id="tab-sraps" class="tabpanel active">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">Use SRAPS</div>
            <div class="value">
              <input type="checkbox" name="global[use_sraps]" value="on" <?= (($wiz['global']['use_sraps'] ?? 'off') === 'on') ? 'checked' : '' ?>>
            </div>

            <div class="label">Push to SRAPS on Generate</div>
            <div class="value">
              <input type="checkbox" name="global[sraps_push_on_generate]" value="on" <?= (($wiz['global']['sraps_push_on_generate'] ?? 'on') === 'on') ? 'checked' : '' ?>>
            </div>

            <div class="label">Organization ID</div>
            <div class="value">
              <input class="small-input" name="global[sraps_org]" value="<?= e($wiz['sraps']['orgId'] ?? '') ?>" placeholder="Company UUID">
            </div>

            <div class="label">Access Key ID</div>
            <div class="value">
              <input class="small-input" name="global[sraps_keyid]" value="<?= e($wiz['sraps']['accessKey'] ?? '') ?>" placeholder="Access Key ID">
            </div>

            <div class="label">Access Key Secret</div>
            <div class="value">
              <input class="small-input" name="global[sraps_secret]" type="password" value="<?= !empty($wiz['sraps']['secretKey']) ? '********' : '' ?>" placeholder="Secret (preserved if left ********)">
            </div>
          </div>
        </div>
      </div>

      <div class="group-actions">
        <a class="btn secondary inline" href="extensions.php?system_id=<?= (int)$sysId ?>" style="text-decoration:none">Cancel</a>
        <button class="btn inline" type="submit" name="save_global" value="1">Save Global</button>
      </div>
    </form>
  </div>
</div>
<?php endif; ?>

<!-- Edit modal -->
<?php if (!empty($show_edit_ext)): $edit_ext = $show_edit_ext; $over = $wiz['settings'][$edit_ext] ?? []; $edit_model = $wiz['assign'][$edit_ext]['model'] ?? ''; $edit_cap = fkey_cap_for_model($edit_model); ?>
<div id="edit-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div>
        <h3 style="margin:0;font-size:16px">Edit Device - Ext <?= e($edit_ext) ?></h3>
        <div class="small" style="margin-top:3px;color:#64748b">Model: <?= e($edit_model ?: 'Unknown') ?> - Max F-keys: <?= (int)$edit_cap ?></div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="tab-pass">Admin Password</div>
      <div class="tab" data-tab="tab-blf">BLF Keys</div>
      <div class="tab" data-tab="tab-custom-ext">Custom XML</div>
    </div>

    <form method="post">
      <input type="hidden" name="ext" value="<?= e($edit_ext) ?>">

      <div id="tab-pass" class="tabpanel active">
        <div class="section-card">
          <div class="form-grid">
            <div class="label">Admin password</div>
            <div class="value">
              <div style="display:flex;gap:8px;align-items:center">
                <?php $masked = !empty($over['http_pass']) ? '*********' : ''; ?>
                <input class="small-input" id="http_pass_mask" type="password" value="<?= e($masked) ?>" readonly placeholder="*********">
                <button type="button" class="btn secondary inline" onclick="toggleHttpPass()">Show/Hide</button>
                <button type="button" class="btn inline" onclick="copyHttpPass()">Copy</button>
                <input type="hidden" name="cfg_http_pass_real" id="cfg_http_pass_real" value="<?= e($over['http_pass'] ?? '') ?>">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-blf" class="tabpanel">
        <div class="section-card">
          <div id="blf-list" style="display:flex;flex-direction:column;gap:8px">
            <?php
              $display_blf = $over['__blf'] ?? [];
              if (empty($display_blf)) $display_blf = [['type'=>'blf','value'=>'','label'=>'']];
              $idx=1;
              foreach($display_blf as $r):
                $val = sanitize_for_ui((string)($r['value'] ?? ''));
                $lab = sanitize_for_ui((string)($r['label'] ?? ''));
            ?>
              <div style="display:flex;gap:8px;align-items:center">
                <strong style="width:28px">#<?= (int)$idx ?></strong>
                <select name="cfg_blf_type[<?= (int)$idx ?>]" class="small-input" style="width:120px">
                  <option value="blf" selected>BLF</option>
                  <option value="none">None</option>
                </select>
                <select name="cfg_blf_ext[<?= (int)$idx ?>]" class="small-input blf-ext" style="width:220px">
                  <option value="">-- Select Extension --</option>
                  <?php foreach ($exts as $e2) {
                      $valOpt=sanitize_for_ui((string)$e2['extension']);
                      $labOpt=sanitize_for_ui((string)$e2['extension'].' - '.$e2['fullname']);
                      $selOpt = ((string)$val === (string)$valOpt) ? 'selected' : '';
                      echo '<option value="'.e($valOpt).'" '.$selOpt.'>'.e($labOpt).'</option>';
                  } ?>
                </select>
                <input class="small-input" name="cfg_blf_value[<?= (int)$idx ?>]" value="<?= e($val) ?>" placeholder="Manual value (e.g. 1001)" style="flex:1">
                <input class="small-input blf-label" name="cfg_blf_label[<?= (int)$idx ?>]" value="<?= e($lab) ?>" placeholder="Label (auto-filled)">
                <button type="button" class="btn ghost inline" onclick="this.closest('div').remove()">Remove</button>
              </div>
            <?php $idx++; endforeach; ?>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div class="small" style="color:#64748b">Up to <?= (int)$edit_cap ?> keys</div>
            <button type="button" class="btn secondary inline" onclick="addBLF()">+ Add BLF</button>
          </div>
        </div>
      </div>

      <div id="tab-custom-ext" class="tabpanel">
        <div class="section-card">
          <textarea class="area" name="cfg[custom_xml]" placeholder="Custom XML under <phone-settings> (per device)"><?php
            $cx = (string)($over['custom_xml'] ?? '');
            echo htmlspecialchars(sanitize_for_ui($cx), ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
          ?></textarea>
        </div>
      </div>

      <div class="group-actions">
        <a class="btn secondary inline" href="extensions.php?system_id=<?= (int)$sysId ?>" style="text-decoration:none">Close</a>
        <button class="btn inline" name="save_settings" value="1" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>
<?php endif; ?>

<!-- SRAPS Quick Panel Modal -->
<div id="sraps-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="sraps-title">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="small" id="sraps-status-line">
        <span id="sraps-dot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:<?= !empty($wiz['sraps']['statusOK']) ? '#16a34a' : '#dc2626' ?>;margin-right:6px;"></span>
        <strong><?= !empty($wiz['sraps']['statusOK']) ? 'Connected' : 'Disconnected' ?></strong>
        <?php if (!empty($wiz['sraps']['statusAt'])): ?>
          <span class="small" style="color:#64748b">Last: <?= e($wiz['sraps']['statusAt']) ?></span>
        <?php endif; ?>
      </div>
      <div><button type="button" class="btn secondary inline" onclick="closeSraps()">Close</button></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="s-cred">Credentials</div>
      <div class="tab" data-tab="s-prof">Profiles</div>
    </div>

    <div id="s-cred" class="tabpanel active">
      <div class="section-card">
        <div class="sraps-grid">
          <div>Base URL</div>
          <div><input id="s-base" class="small-input" placeholder="https://api.sraps.snom.com/api/v1/" value="<?= e($wiz['sraps']['baseUrl'] ?? 'https://api.sraps.snom.com/api/v1/') ?>"></div>

          <div>Organization ID</div>
          <div><input id="s-org" class="small-input" placeholder="Company UUID" value="<?= e($wiz['sraps']['orgId'] ?? '') ?>"></div>

          <div>Access Key ID</div>
          <div><input id="s-id" class="small-input" placeholder="API Key ID" value="<?= e($wiz['sraps']['accessKey'] ?? '') ?>"></div>

          <div>Access Key Secret</div>
          <div><input id="s-key" class="small-input" type="password" placeholder="API Key Secret" value="<?= !empty($wiz['sraps']['secretKey']) ? '********' : '' ?>"></div>
        </div>
        <div class="group-actions" style="justify-content:flex-start">
          <button id="s-save" type="button" class="btn inline">Save</button>
          <button id="s-test" type="button" class="btn secondary inline">Test Connection</button>
          <span class="hint">Save stores keys in session and DB (secret hidden). Click Test to validate.</span>
        </div>
      </div>
    </div>

    <div id="s-prof" class="tabpanel">
      <div class="section-card">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button id="s-load-prof" type="button" class="btn secondary inline">Load Profiles</button>
          <span id="s-prof-count" class="hint"></span>
        </div>
        <div class="sraps-grid">
          <div>D Series</div><div><select id="s-prof-D" class="small-input"><option value="">-- select --</option></select></div>
          <div>M Series</div><div><select id="s-prof-M" class="small-input"><option value="">-- select --</option></select></div>
          <div>M500</div><div><select id="s-prof-M500" class="small-input"><option value="">-- select --</option></select></div>
          <div>Hotel Phones</div><div><select id="s-prof-HOTEL" class="small-input"><option value="">-- select --</option></select></div>
        </div>
        <div class="group-actions" style="justify-content:flex-start">
          <button id="s-save-prof" type="button" class="btn inline">Save Profiles</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const MAC_LIST = <?= $mac_list_json ?: '[]' ?>;
const ASSIGNED_MACS = <?= $assigned_macs_json ?: '{}' ?>;
const FLASH_MSG = <?= json_encode($toast_msg) ?: '""' ?>;
const FLASH_TYPE = <?= json_encode($toast_type) ?: '"success"' ?>;
const SYSTEM_ID = <?= json_encode($sysId) ?>;
const EXT_TO_NAME = <?= $ext_to_fullname_json ?: '{}' ?>;
<?php if (!empty($show_edit_ext)): ?>const BLF_CAP = <?= (int)$edit_cap ?>;<?php else: ?>const BLF_CAP = null;<?php endif; ?>

function showToast(message, type='success', duration=5000) {
  message = String(message || '').replace(/\s+/g,' ').replace(/\?+\s*$/,'').trim();
  if (!message) return;
  document.querySelectorAll('.center-toast-overlay').forEach(el => el.remove());
  const overlay = document.createElement('div'); overlay.className = 'center-toast-overlay'; overlay.setAttribute('role','status');
  const box = document.createElement('div'); box.className = 'center-toast ' + (type==='warn' ? 'warn' : 'success');
  const txt = document.createElement('div'); txt.style.flex = '1'; txt.style.textAlign = 'center'; txt.textContent = message;
  const close = document.createElement('button'); close.className = 'close-btn'; close.innerHTML = '&times;'; close.title='Close';
  close.addEventListener('click', () => overlay.remove());
  box.appendChild(txt); box.appendChild(close); overlay.appendChild(box); document.body.appendChild(overlay);
  setTimeout(()=>{ overlay.remove(); }, duration);
}

document.addEventListener('DOMContentLoaded', function(){
  try { if (FLASH_MSG) showToast(FLASH_MSG, FLASH_TYPE, 5000); } catch(e){}

  document.querySelectorAll('.tabpanel').forEach(p=>{
    p.style.display = p.classList.contains('active') ? 'block' : 'none';
  });

  document.querySelectorAll('.tabs').forEach(tabsEl=>{
    tabsEl.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        const tgt = tab.getAttribute('data-tab');
        const panel = document.getElementById(tgt);

        tabsEl.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');

        let groupPanels = [];
        if (panel && panel.parentElement) {
          groupPanels = Array.from(panel.parentElement.querySelectorAll('.tabpanel'));
        } else {
          groupPanels = Array.from(document.querySelectorAll('.tabpanel'));
        }
        groupPanels.forEach(p=>{
          p.classList.remove('active');
          p.style.display = 'none';
        });
        if (panel) {
          panel.classList.add('active');
          panel.style.display = 'block';
        }
      });
    });
  });

  // Toggle force admin password field
  const chk = document.getElementById('force_admin_password');
  const pwd = document.getElementById('forced_admin_password');
  if (chk && pwd) {
    chk.addEventListener('change', ()=> {
      if (chk.checked) { pwd.removeAttribute('disabled'); pwd.focus(); }
      else { pwd.setAttribute('disabled','disabled'); }
    });
  }

  // Dynamic search (client-side only)
  const searchInput = document.getElementById('search-all');
  const searchBtn = document.getElementById('search-btn');
  function applySearchFilter() {
    const q = (searchInput.value || '').toLowerCase().trim();
    const rows = document.querySelectorAll('#assign-form tbody tr');
    rows.forEach(tr => {
      const ext = (tr.querySelector('.col-ext')?.textContent || '').toLowerCase();
      const full = (tr.querySelector('.col-full')?.textContent || '').toLowerCase();
      const mac = (tr.querySelector('.col-mac input')?.value || '').toLowerCase();
      const model = (tr.querySelector('.col-model select')?.value || '').toLowerCase();
      const hay = ext + ' ' + full + ' ' + mac + ' ' + model;
      tr.style.display = (q === '' || hay.indexOf(q) !== -1) ? '' : 'none';
    });
  }
  if (searchInput) {
    searchInput.addEventListener('input', applySearchFilter);
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); applySearchFilter(); }
    });
  }
  if (searchBtn) searchBtn.addEventListener('click', applySearchFilter);

  attachMacCombos();

  // wire SRAPS modal button
  const openSrapsBtn = document.getElementById('open-sraps');
  if (openSrapsBtn) openSrapsBtn.addEventListener('click', openSraps);

  // Prefill SRAPS modal fields from server-side saved values
  try {
    document.getElementById('s-base').value = "<?= e($wiz['sraps']['baseUrl'] ?? 'https://api.sraps.snom.com/api/v1/') ?>";
    document.getElementById('s-org').value = "<?= e($wiz['sraps']['orgId'] ?? '') ?>";
    document.getElementById('s-id').value  = "<?= e($wiz['sraps']['accessKey'] ?? '') ?>";
    document.getElementById('s-key').value = <?= !empty($wiz['sraps']['secretKey']) ? json_encode('********') : json_encode('') ?>;
  } catch (e) {}

  // SRAPS Save/Test handlers
  const sSave = document.getElementById('s-save');
  if (sSave) sSave.addEventListener('click', async ()=>{
    const base = document.getElementById('s-base').value.trim();
    const org = document.getElementById('s-org').value.trim();
    const id  = document.getElementById('s-id').value.trim();
    const secret = document.getElementById('s-key').value;
    try {
      await srapsApi('save_creds','POST',{ baseUrl: base, orgId: org, accessKey: id, secretKey: secret || null });
      try {
        await srapsApi('test','GET');
        setSrapsConnected(true, new Date().toISOString());
        showToast('Connection to SRAPS Established','success');
      } catch (err) {
        setSrapsConnected(false, new Date().toISOString());
        showToast(err.message || 'Connection failed','warn');
      }
    } catch (e) { showToast(e.message || 'Save failed','warn'); }
  });

  const sTest = document.getElementById('s-test');
  if (sTest) sTest.addEventListener('click', async ()=>{
    try { await srapsApi('test','GET'); setSrapsConnected(true, new Date().toISOString()); showToast('Connection to SRAPS Established','success'); }
    catch (e) { setSrapsConnected(false, new Date().toISOString()); showToast(e.message || 'Connection failed','warn'); }
  });

  // load profiles
  const sLoad = document.getElementById('s-load-prof');
  if (sLoad) sLoad.addEventListener('click', async ()=>{
    try {
      const r = await srapsApi('get_profiles','GET');
      const profiles = Array.isArray(r.profiles) ? r.profiles : [];
      document.getElementById('s-prof-count').textContent = String(profiles.length) + ' profiles';
      fillProfilesSelect(document.getElementById('s-prof-D'), profiles, "<?= e($wiz['sraps']['profilesCat']['D'] ?? '') ?>");
      fillProfilesSelect(document.getElementById('s-prof-M'), profiles, "<?= e($wiz['sraps']['profilesCat']['M'] ?? '') ?>");
      fillProfilesSelect(document.getElementById('s-prof-M500'), profiles, "<?= e($wiz['sraps']['profilesCat']['M500'] ?? '') ?>");
      fillProfilesSelect(document.getElementById('s-prof-HOTEL'), profiles, "<?= e($wiz['sraps']['profilesCat']['HOTEL'] ?? '') ?>");
      showToast('Profiles loaded','success');
    } catch (e) { showToast(e.message || 'Failed to load profiles','warn'); }
  });

  const sSaveProf = document.getElementById('s-save-prof');
  if (sSaveProf) sSaveProf.addEventListener('click', async ()=>{
    try {
      await srapsApi('save_category_profiles','POST',{
        profile_D: document.getElementById('s-prof-D').value || '',
        profile_M: document.getElementById('s-prof-M').value || '',
        profile_M500: document.getElementById('s-prof-M500').value || '',
        profile_HOTEL: document.getElementById('s-prof-HOTEL').value || ''
      });
      showToast('Profiles saved','success');
    } catch (e) { showToast(e.message || 'Save failed','warn'); }
  });
});

function openSraps(){ document.getElementById('sraps-modal').style.display='flex'; }
function closeSraps(){ document.getElementById('sraps-modal').style.display='none'; }
function setSrapsConnected(ok, when){
  const dot = document.getElementById('sraps-dot');
  if (dot) dot.style.background = ok ? '#16a34a' : '#dc2626';
  const line = document.getElementById('sraps-status-line');
  if (line) line.querySelector('strong').textContent = ok ? 'Connected' : 'Disconnected';
  if (line) {
    let ts = line.querySelector('.small');
    if (!ts){ ts = document.createElement('span'); ts.className='small'; ts.style.color='#64748b'; line.appendChild(ts); }
    ts.textContent = when ? (' Last: ' + when) : '';
  }
}
async function srapsApi(action, method='GET', body=null){
  const url = 'extensions.php?system_id='+encodeURIComponent(<?= json_encode((int)$sysId) ?>)+'&sraps_action='+encodeURIComponent(action);
  const opts = { method, headers:{} };
  if (body!==null){ opts.headers['Content-Type']='application/json'; opts.body = JSON.stringify(body); }
  const res = await fetch(url, opts);
  const data = await res.json().catch(()=>null);
  if (!res.ok) throw new Error((data && data.error) ? data.error : ('HTTP '+res.status));
  return data;
}
function fillProfilesSelect(sel, items, saved){
  sel.innerHTML = '<option value="">-- select --</option>' + items.map(p=>{
    const id = (p.uuid || p.uuid_v4 || p.id || '').toString();
    const name = (p.name || p.display_name || id || '').toString().replace(/</g,'&lt;');
    return `<option value="${id}">${name}</option>`;
  }).join('');
  if (saved) {
    const opt = Array.from(sel.options).find(o=>o.value===saved);
    if (opt) sel.value = saved;
  }
}

/* Generic helpers */
function switchSiteGo(){
  const sel = document.getElementById('switch-site-select');
  const modal = document.getElementById('switch-site-modal');
  if (!sel || !sel.value) { if (modal) modal.style.display='none'; return; }
  window.location.href = 'extensions.php?system_id=' + encodeURIComponent(sel.value);
}

function toggleHttpPass() {
  const mask = document.getElementById('http_pass_mask');
  const real = document.getElementById('cfg_http_pass_real');
  if (!mask || !real) return;
  const visible = (mask.type === 'text');
  if (visible) {
    mask.type = 'password';
    mask.readOnly = true;
    mask.value = real.value ? '*********' : '';
  } else {
    mask.type = 'text';
    mask.readOnly = true;
    mask.value = (real.value || '');
  }
}

function copyHttpPass() {
  const real = document.getElementById('cfg_http_pass_real');
  const mask = document.getElementById('http_pass_mask');
  let secret = (real && real.value) ? real.value : '';
  if (!secret && mask && mask.type === 'text' && mask.value && mask.value !== '*********') {
    secret = mask.value;
  }
  if (!secret) { showToast('No password available to copy','warn'); return; }
  if (navigator && navigator.clipboard && navigator.clipboard.writeText && (window.isSecureContext || location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
    navigator.clipboard.writeText(secret).then(()=>showToast('Password copied','success')).catch(()=>fallbackCopy(secret));
  } else {
    fallbackCopy(secret);
  }
  function fallbackCopy(text) {
    try {
      const ta=document.createElement('textarea'); ta.value=text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.left='-9999px'; ta.style.opacity='0'; document.body.appendChild(ta);
      ta.focus(); ta.select(); ta.setSelectionRange(0, ta.value.length);
      const ok=document.execCommand('copy'); document.body.removeChild(ta);
      showToast(ok?'Password copied':'Copy failed', ok?'success':'warn');
    } catch(e){ showToast('Copy failed','warn'); }
  }
}

function currentBLFRowCount(){
  const list=document.getElementById('blf-list'); if (!list) return 0;
  return Array.from(list.querySelectorAll('select[name^="cfg_blf_type"]')).filter(s=> (s.value||'blf') !== 'none').length;
}
function addBLF(){
  const list=document.getElementById('blf-list'); if(!list) return;
  if (BLF_CAP !== null && currentBLFRowCount() >= BLF_CAP) { showToast('Reached maximum F-keys.','warn'); return; }
  const nextIdx = (list.querySelectorAll('select[name^="cfg_blf_type"]').length + 1);
  let extHtml = document.querySelector('#blf-list select[name^="cfg_blf_ext"]')?.innerHTML || '<option value="">-- Select Extension --</option>';
  const div=document.createElement('div'); div.style.display='flex'; div.style.gap='8px'; div.style.alignItems='center';
  div.innerHTML = `<strong style="width:28px">#${nextIdx}</strong>
  <select name="cfg_blf_type[${nextIdx}]" class="small-input" style="width:120px"><option value="blf" selected>BLF</option><option value="none">None</option>;
</option></select>
  <select name="cfg_blf_ext[${nextIdx}]" class="small-input blf-ext" style="width:220px">${extHtml}</select>
  <input class="small-input" name="cfg_blf_value[${nextIdx}]" placeholder="Manual value (e.g. 1001)" style="flex:1">
  <input class="small-input blf-label" name="cfg_blf_label[${nextIdx}]" placeholder="Label" style="width:200px">
  <button type="button" class="btn ghost inline" onclick="this.closest('div').remove()">Remove</button>`;
  list.appendChild(div);
}

/* Post helpers */
function postEdit(ext){ if(!ext) return; const f=document.createElement('form'); f.method='post'; f.style.display='none'; f.action='extensions.php?system_id=' + encodeURIComponent(SYSTEM_ID); const i=document.createElement('input'); i.type='hidden'; i.name='edit'; i.value=ext; f.appendChild(i); document.body.appendChild(f); f.submit(); }
function postGenerate(ext){ if(!ext) return; const f=document.createElement('form'); f.method='post'; f.style.display='none'; f.action='extensions.php?system_id=' + encodeURIComponent(SYSTEM_ID); const macInput = document.querySelector('input[name="assign['+ext+'][mac]"]'); if (macInput) { const h=document.createElement('input'); h.type='hidden'; h.name='assign['+ext+'][mac]'; h.value=(macInput.value||''); f.appendChild(h); } const modelSel = document.querySelector('select[name="assign['+ext+'][model]"]'); if (modelSel) { const h=document.createElement('input'); h.type='hidden'; h.name='assign['+ext+'][model]'; h.value=(modelSel.value||''); f.appendChild(h); } const i=document.createElement('input'); i.type='hidden'; i.name='generate_one'; i.value=ext; f.appendChild(i); document.body.appendChild(f); f.submit(); }
function confirmDelete(ext){ if (!ext) return; if (!confirm('Delete generated provisioning file for extension ' + ext + ' ?')) return; const f=document.createElement('form'); f.method='post'; f.style.display='none'; f.action='extensions.php?system_id=' + encodeURIComponent(SYSTEM_ID); const i=document.createElement('input'); i.type='hidden'; i.name='delete_generated'; i.value = ext; f.appendChild(i); document.body.appendChild(f); f.submit(); }

/* MAC combo with suggestions - ensure list shows after CSV upload */
function attachMacCombos() {
  const macList = Array.isArray(MAC_LIST) ? MAC_LIST : [];
  document.querySelectorAll('.mac-combo').forEach(combo => {
    const input = combo.querySelector('.mac-combo-input');
    const listEl = combo.querySelector('.mac-combo-list');
    if (!input || !listEl) return;
    const ext = combo.getAttribute('data-ext') || '';
    function normalizeDisplayMac(s){ return String(s||'').replace(/[^A-Fa-f0-9]/g,'').toUpperCase(); }
    function findModelForMac(mac) {
      if (!mac) return '';
      for (let i=0;i<macList.length;i++){
        const m = (macList[i].mac || macList[i].MAC || '').toString().replace(/[^A-Fa-f0-9]/g,'').toUpperCase();
        if (m === mac) return (macList[i].model || '').toString();
      }
      return '';
    }
    function setModelForExt(extLocal, model) {
      if (!extLocal) return;
      const sel = document.querySelector('select[name="assign['+extLocal+'][model]"]');
      if (sel && model) {
        let found=false;
        for (let i=0;i<sel.options.length;i++){
          if (sel.options[i].value === model) { sel.selectedIndex = i; found=true; break; }
        }
        if (!found) { const opt = document.createElement('option'); opt.value = model; opt.text = model; opt.selected = true; sel.appendChild(opt); }
      }
    }
    function buildList(filterQ='') {
      listEl.innerHTML = '';
      const q = normalizeDisplayMac(filterQ);
      let any = 0;
      macList.forEach(it => {
        const mac = normalizeDisplayMac(it.mac || it.MAC || '');
        if (!mac) return;
        const assignedTo = (ASSIGNED_MACS && ASSIGNED_MACS[mac]) ? ASSIGNED_MACS[mac] : null;
        if (assignedTo && assignedTo !== ext) return;
        if (q === '' || mac.indexOf(q) !== -1) {
          const item = document.createElement('div'); item.className = 'mac-combo-item'; item.tabIndex = -1;
          item.dataset.value = mac; item.dataset.model = (it.model || '').toString();
          item.textContent = mac + (it.model ? ' ' + it.model : '');
          listEl.appendChild(item); any++;
        }
      });
      if (any === 0) { const empty = document.createElement('div'); empty.className = 'mac-combo-empty'; empty.textContent = 'No suggestions'; listEl.appendChild(empty); }
      const first = listEl.querySelector('.mac-combo-item'); if (first) first.classList.add('active');
      listEl.style.display = 'block';
    }
    function showList() { buildList(input.value || ''); listEl.style.display = 'block'; }
    function hideListSoon() { setTimeout(()=>listEl.style.display='none', 150); }
    function hideList() { listEl.style.display = 'none'; }

    input.addEventListener('focus', showList);
    input.addEventListener('input', function(){ showList(); });
    input.addEventListener('blur', function(){
      input.value = normalizeDisplayMac(input.value || '');
      const model = findModelForMac(input.value || '');
      if (model) setModelForExt(ext, model);
      hideListSoon();
    });
    input.addEventListener('keydown', function(ev){
      const visible = Array.from(listEl.querySelectorAll('.mac-combo-item')).filter(it => it.offsetParent !== null);
      const active = listEl.querySelector('.mac-combo-item.active');
      if (ev.key === 'ArrowDown') {
        ev.preventDefault();
        if (listEl.style.display !== 'block') { showList(); return; }
        if (!visible.length) return;
        if (!active) { visible[0].classList.add('active'); visible[0].scrollIntoView({block:'nearest'}); return; }
        const idx = visible.indexOf(active); const next = visible[idx+1] || visible[0];
        active.classList.remove('active'); next.classList.add('active'); next.scrollIntoView({block:'nearest'});
      } else if (ev.key === 'ArrowUp') {
        ev.preventDefault();
        if (listEl.style.display !== 'block') { showList(); return; }
        if (!visible.length) return;
        if (!active) { visible[visible.length-1].classList.add('active'); visible[visible.length-1].scrollIntoView({block:'nearest'}); return; }
        const idx = visible.indexOf(active); const prev = visible[idx-1] || visible[visible.length-1];
        active.classList.remove('active'); prev.classList.add('active'); prev.scrollIntoView({block:'nearest'});
      } else if (ev.key === 'Enter') {
        if (listEl.style.display === 'block') {
          const pick = listEl.querySelector('.mac-combo-item.active');
          if (pick && pick.dataset && pick.dataset.value) {
            ev.preventDefault();
            input.value = pick.dataset.value;
            if (pick.dataset.model) setModelForExt(ext, pick.dataset.model);
            input.dispatchEvent(new Event('input',{bubbles:true}));
            hideList();
          }
        }
      } else if (ev.key === 'Escape') { hideList(); }
    });
    listEl.addEventListener('mousedown', function(ev){
      const it = ev.target.closest('.mac-combo-item'); if (!it || !it.dataset) return;
      ev.preventDefault();
      input.value = it.dataset.value || '';
      if (it.dataset.model) setModelForExt(ext, it.dataset.model);
      input.dispatchEvent(new Event('input',{bubbles:true}));
      hideList(); input.focus();
    });
    document.addEventListener('click', function(ev){ if (!combo.contains(ev.target)) hideList(); });
  });
}
</script>
<!-- UI_BUILD: <?= e($UI_BUILD) ?> | file: <?= e(__FILE__) ?> | mtime: <?= filemtime(__FILE__) ?> -->
</body>
</html>
